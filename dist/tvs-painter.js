!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.tvsPainter=t():e.tvsPainter=t()}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);var n={};r.r(n),r.d(n,"GEOMETRY_PROP_POSITION",function(){return u}),r.d(n,"GEOMETRY_PROP_NORMAL",function(){return f}),r.d(n,"GEOMETRY_PROP_UV",function(){return _}),r.d(n,"UNIFORM_SOURCE_TEXTURE",function(){return l}),r.d(n,"VARYING_UV_COORDS",function(){return T}),r.d(n,"GL_TYPE",function(){return c});var i={};r.r(i),r.d(i,"defaultTextureSettings",function(){return E}),r.d(i,"getDefaultLayerSettings",function(){return h}),r.d(i,"defaultForms",function(){return d}),r.d(i,"defaultShaders",function(){return A});var s={};r.r(s),r.d(s,"getContext",function(){return S}),r.d(s,"makeClear",function(){return R}),r.d(s,"setBlendFunc",function(){return m}),r.d(s,"resizeCanvas",function(){return y});var a={};r.r(a),r.d(a,"plane",function(){return F});var o={};r.r(o),r.d(o,"STACK_GL_GEOMETRY_PROP_POSITION",function(){return b}),r.d(o,"STACK_GL_GEOMETRY_PROP_NORMAL",function(){return g}),r.d(o,"STACK_GL_GEOMETRY_PROP_UV",function(){return U}),r.d(o,"STACK_GL_GEOMETRY_PROP_ELEMENTS",function(){return N}),r.d(o,"convertStackGLGeometry",function(){return L});const u="position",f="normal",_="uv",l="source",T="coords",c={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FLOAT_MAT2X3:35685,FLOAT_MAT2X4:35686,FLOAT_MAT3X2:35687,FLOAT_MAT3X4:35688,FLOAT_MAT4X2:35689,FLOAT_MAT4X3:35690,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879,TEXTURE_2D_ARRAY:35866,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042},E={wrap:"CLAMP_TO_EDGE",minFilter:"LINEAR",magFilter:"NEAREST"};function h(e){return{clearColor:[0,0,0,1],blendFunc:[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]}}const d={renderQuad:{attribs:{[u]:{buffer:new Float32Array([-1,1,-1,-1,1,1,1,-1]),storeType:"STATIC"},[_]:{buffer:new Float32Array([0,1,0,0,1,1,1,0]),storeType:"STATIC"}},drawType:"TRIANGLE_STRIP",itemCount:4}},A={basicEffect:{vert:`\nattribute vec2 ${u};\nattribute vec2 ${_};\nvarying vec2 ${T};\nvoid main() {\n\t${T} = ${_};\n\tgl_Position = vec4(${u}, 0.0, 1.0);\n}`,frag:`precision mediump float;\nuniform sampler2D ${l};\nvarying vec2 ${T};\nvoid main() {\n\tgl_FragColor = texture2D(${l}, ${T});\n}`}};function S(e,t){const r=e.getContext("webgl",t)||e.getContext("experimental-webgl",t);if(null==r)throw Error("Webgl context cannot be initialized");return r}function R(e,...t){return t.reduce((t,r)=>t|e[r.toUpperCase()+"_BUFFER_BIT"],0)}function m(e,t){e.blendFunc.apply(e,t.map(t=>e[t.toUpperCase()]))}function y(e,t=1){const r=e.clientWidth*t|0,n=e.clientHeight*t|0;return(e.width!==r||e.height!==n)&&(e.width=r,e.height=n,!0)}function F(e,t,r,n){const i=e/2,s=t/2,a=r||1,o=n||1,u=a+1,f=o+1,_=e/a,l=t/o,T=new Float32Array(u*f*3),c=new Float32Array(u*f*3),E=new Float32Array(u*f*2);let h,d,A=0,S=0;for(h=0;h<f;h++){const e=h*l-s;for(d=0;d<u;d++){const t=d*_-i;T[A]=t,T[A+1]=-e,c[A+2]=1,E[S]=d/a,E[S+1]=1-h/o,A+=3,S+=2}}A=0;const R=new(T.length/3>65535?Uint32Array:Uint16Array)(a*o*6);for(h=0;h<o;h++)for(d=0;d<a;d++){const e=d+u*h,t=d+u*(h+1),r=d+1+u*(h+1),n=d+1+u*h;R[A]=e,R[A+1]=t,R[A+2]=n,R[A+3]=t,R[A+4]=r,R[A+5]=n,A+=6}return{attribs:{position:{buffer:T},normal:{buffer:c},uv:{buffer:E}},elements:{buffer:R},drawType:"TRIANGLES",itemCount:R.length}}function p(e,t=[]){for(const r of e){const e=t.length;for(let n=0;n<r.length;n++)t[n+e]=r[n]}return t}const b="positions",g="normals",U="uvs",N="cells";function L(e){const t={drawType:"TRIANGLES",attribs:{},itemCount:0};for(const r in e){const n=e[r];if(r===N){const e=new(n.length>65535?Uint32Array:Uint16Array)(p(n));Object.assign(t,{elements:{buffer:e},itemCount:e.length})}else r===b?t.attribs[u]={buffer:new Float32Array(p(n))}:r===g?t.attribs[f]={buffer:new Float32Array(p(n))}:r===U?t.attribs[_]={buffer:new Float32Array(p(n))}:t.attribs[r]={buffer:new Float32Array(p(n))}}return t}function O(e){return z[e].bindPoint}function I(e,t){return r=>{e.uniform1i(t,r)}}function M(e,t){return r=>{e.uniform1iv(t,r)}}function D(e,t){return r=>{e.uniform2iv(t,r)}}function P(e,t){return r=>{e.uniform3iv(t,r)}}function w(e,t){return r=>{e.uniform4iv(t,r)}}function B(e,t,r,n){const i=O(t);return t=>{e.uniform1i(n,r),e.activeTexture(e.TEXTURE0+r),e.bindTexture(i,t)}}function C(e,t,r,n,i){const s=O(t),a=new Int32Array(i);for(let e=0;e<i;++e)a[e]=r+e;return t=>{e.uniform1iv(n,a);for(const r in t)e.activeTexture(e.TEXTURE0+a[r]),e.bindTexture(s,t[r])}}const z={[c.FLOAT]:{Type:Float32Array,size:4,setter:function(e,t){return r=>{e.uniform1f(t,r)}},arraySetter:function(e,t){return r=>{e.uniform1fv(t,r)}}},[c.FLOAT_VEC2]:{Type:Float32Array,size:8,setter:function(e,t){return r=>{e.uniform2fv(t,r)}}},[c.FLOAT_VEC3]:{Type:Float32Array,size:12,setter:function(e,t){return r=>{e.uniform3fv(t,r)}}},[c.FLOAT_VEC4]:{Type:Float32Array,size:16,setter:function(e,t){return r=>{e.uniform4fv(t,r)}}},[c.INT]:{Type:Int32Array,size:4,setter:I,arraySetter:M},[c.INT_VEC2]:{Type:Int32Array,size:8,setter:D},[c.INT_VEC3]:{Type:Int32Array,size:12,setter:P},[c.INT_VEC4]:{Type:Int32Array,size:16,setter:w},[c.UNSIGNED_INT]:{Type:Uint32Array,size:4,setter:function(e,t){return r=>{e.uniform1ui(t,r)}},arraySetter:function(e,t){return r=>{e.uniform1uiv(t,r)}}},[c.UNSIGNED_INT_VEC2]:{Type:Uint32Array,size:8,setter:function(e,t){return r=>{e.uniform2uiv(t,r)}}},[c.UNSIGNED_INT_VEC3]:{Type:Uint32Array,size:12,setter:function(e,t){return r=>{e.uniform3uiv(t,r)}}},[c.UNSIGNED_INT_VEC4]:{Type:Uint32Array,size:16,setter:function(e,t){return r=>{e.uniform4uiv(t,r)}}},[c.BOOL]:{Type:Uint32Array,size:4,setter:I,arraySetter:M},[c.BOOL_VEC2]:{Type:Uint32Array,size:8,setter:D},[c.BOOL_VEC3]:{Type:Uint32Array,size:12,setter:P},[c.BOOL_VEC4]:{Type:Uint32Array,size:16,setter:w},[c.FLOAT_MAT2]:{Type:Float32Array,size:16,setter:function(e,t){return r=>{e.uniformMatrix2fv(t,!1,r)}}},[c.FLOAT_MAT3]:{Type:Float32Array,size:36,setter:function(e,t){return r=>{e.uniformMatrix3fv(t,!1,r)}}},[c.FLOAT_MAT4]:{Type:Float32Array,size:64,setter:function(e,t){return r=>{e.uniformMatrix4fv(t,!1,r)}}},[c.FLOAT_MAT2X3]:{Type:Float32Array,size:24,setter:function(e,t){return r=>{e.uniformMatrix2x3fv(t,!1,r)}}},[c.FLOAT_MAT2X4]:{Type:Float32Array,size:32,setter:function(e,t){return r=>{e.uniformMatrix2x4fv(t,!1,r)}}},[c.FLOAT_MAT3X2]:{Type:Float32Array,size:24,setter:function(e,t){return r=>{e.uniformMatrix3x2fv(t,!1,r)}}},[c.FLOAT_MAT3X4]:{Type:Float32Array,size:48,setter:function(e,t){return r=>{e.uniformMatrix3x4fv(t,!1,r)}}},[c.FLOAT_MAT4X2]:{Type:Float32Array,size:32,setter:function(e,t){return r=>{e.uniformMatrix4x2fv(t,!1,r)}}},[c.FLOAT_MAT4X3]:{Type:Float32Array,size:48,setter:function(e,t){return r=>{e.uniformMatrix4x3fv(t,!1,r)}}},[c.SAMPLER_2D]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D},[c.SAMPLER_CUBE]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_CUBE_MAP},[c.SAMPLER_3D]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_3D},[c.SAMPLER_2D_SHADOW]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D},[c.SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D_ARRAY},[c.SAMPLER_2D_ARRAY_SHADOW]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D_ARRAY},[c.SAMPLER_CUBE_SHADOW]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_CUBE_MAP},[c.INT_SAMPLER_2D]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D},[c.INT_SAMPLER_3D]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_3D},[c.INT_SAMPLER_CUBE]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_CUBE_MAP},[c.INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D_ARRAY},[c.UNSIGNED_INT_SAMPLER_2D]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D},[c.UNSIGNED_INT_SAMPLER_3D]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_3D},[c.UNSIGNED_INT_SAMPLER_CUBE]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_CUBE_MAP},[c.UNSIGNED_INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:B,arraySetter:C,bindPoint:c.TEXTURE_2D_ARRAY}};function v(e,t,r){return n=>{e.bindBuffer(e.ARRAY_BUFFER,n.buffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,r.itemSize,c.FLOAT,n.normalize||!1,n.stride||0,n.offset||0)}}function x(e,t,r){return n=>{e.bindBuffer(e.ARRAY_BUFFER,n.buffer),e.enableVertexAttribArray(t),e.vertexAttribIPointer(t,r.itemSize,c.INT,n.stride||0,n.offset||0)}}function G(e,t,r){const n=r.size,i=r.count;return r=>{e.bindBuffer(e.ARRAY_BUFFER,r.buffer);const s=n,a=s/i,o=z[c.FLOAT].size*s,u=r.normalize||!1,f=r.offset||0,_=o/i;for(let r=0;r<i;++r)e.enableVertexAttribArray(t+r),e.vertexAttribPointer(t+r,a,c.FLOAT,u,o,f+_*r)}}const X={[c.FLOAT]:{size:4,setter:v,itemSize:1},[c.FLOAT_VEC2]:{size:8,setter:v,itemSize:2},[c.FLOAT_VEC3]:{size:12,setter:v,itemSize:3},[c.FLOAT_VEC4]:{size:16,setter:v,itemSize:4},[c.INT]:{size:4,setter:x,itemSize:1},[c.INT_VEC2]:{size:8,setter:x,itemSize:2},[c.INT_VEC3]:{size:12,setter:x,itemSize:3},[c.INT_VEC4]:{size:16,setter:x,itemSize:4},[c.UNSIGNED_INT]:{size:4,setter:x,itemSize:1},[c.UNSIGNED_INT_VEC2]:{size:8,setter:x,itemSize:2},[c.UNSIGNED_INT_VEC3]:{size:12,setter:x,itemSize:3},[c.UNSIGNED_INT_VEC4]:{size:16,setter:x,itemSize:4},[c.BOOL]:{size:4,setter:x,itemSize:1},[c.BOOL_VEC2]:{size:8,setter:x,itemSize:2},[c.BOOL_VEC3]:{size:12,setter:x,itemSize:3},[c.BOOL_VEC4]:{size:16,setter:x,itemSize:4},[c.FLOAT_MAT2]:{size:4,setter:G,count:2},[c.FLOAT_MAT3]:{size:9,setter:G,count:3},[c.FLOAT_MAT4]:{size:16,setter:G,count:4}};Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array,Uint16Array,Uint16Array,Uint16Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array;function V(e,t={},r={}){if(null!=t.flipY&&t.flipY!==r.flipY&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY),t.wrap&&t.wrap!==r.wrap||t.wrapS&&t.wrapS!==r.wrapS||t.wrapT&&t.wrapT!==r.wrapT){let r,n;t.wrap?r=n=t.wrap:(n=t.wrapT||"CLAMP_TO_EDGE",r=t.wrapS||"CLAMP_TO_EDGE"),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[r]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[n])}t.magFilter&&t.magFilter!==r.magFilter&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[t.magFilter]),t.minFilter&&t.minFilter!==r.minFilter&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[t.minFilter])}function Y(e,t,r,n){if(null==t.width||null==t.height)return;null==t.frameBuffer&&(t.frameBuffer=e.createFramebuffer()),t.textures||(t.textures=[]),e.bindFramebuffer(e.FRAMEBUFFER,t.frameBuffer),t.bufferStructure.some(e=>"FLOAT"===e)&&e.getExtension("OES_texture_float");const i=t.bufferStructure.length;if(i>1){const s=e.getExtension("WEBGL_draw_buffers")||{drawBuffersWEBGL(){}},a=[];for(let e=0;e<i;e++)a.push(s[`COLOR_ATTACHMENT${e}_WEBGL`]);s.drawBuffersWEBGL(a);for(let s=0;s<i;s++){null==t.textures[s]&&(t.textures[s]=e.createTexture());const i=t.textures[s];e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,e[t.bufferStructure[s]],null),V(e,r,n),e.framebufferTexture2D(e.FRAMEBUFFER,a[s],e.TEXTURE_2D,i,0)}}else{null==t.textures[0]&&(t.textures[0]=e.createTexture());const i=t.textures[0];e.bindTexture(e.TEXTURE_2D,i),V(e,r,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,e[t.bufferStructure[0]],null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}null==t.depthBuffer&&(t.depthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t.depthBuffer);const s=e.checkFramebufferStatus(e.FRAMEBUFFER);s!==e.FRAMEBUFFER_COMPLETE&&console.error("framebuffer error",s,r),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null)}function k(e,t){if(t.enable)for(const r of t.enable)e.enable(r);if(t.disable)for(const r of t.disable)e.disable(r);t.blendFunc&&e.blendFunc.apply(e,t.blendFunc),null!=t.depthFunc&&e.depthFunc(t.depthFunc),null!=t.cullFace&&e.cullFace(t.cullFace),null!=t.frontFace&&e.frontFace(t.frontFace),null!=t.lineWidth&&e.lineWidth(t.lineWidth),t.colorMask&&e.colorMask.apply(e,t.colorMask),null!=t.depthMask&&e.depthMask(t.depthMask),t.clearColor&&e.clearColor.apply(e,t.clearColor),null!=t.clearDepth&&e.clearDepth(t.clearDepth),null!=t.clearBits&&e.clear(t.clearBits)}function H(e,t){if(t.enable)for(const r of t.enable)e.disable(r);if(t.disable)for(const r of t.disable)e.enable(r)}let W=1;class j{constructor(e,t="Form"+W++){this._gl=e,this.id=t}update(e){const t=this._gl;e.drawType&&(this._drawType=t[e.drawType]),e.itemCount&&(this._itemCount=e.itemCount),this._attribs=this._attribs||{};for(const r in e.attribs){const n=e.attribs[r];null==this._attribs[r]&&(this._attribs[r]={buffer:t.createBuffer()}),t.bindBuffer(t.ARRAY_BUFFER,this._attribs[r].buffer),t.bufferData(t.ARRAY_BUFFER,n.buffer,t[(n.storeType||"STATIC")+"_DRAW"])}if(e.elements){const r=e.elements.buffer;null==this._elements&&(this._elements={buffer:t.createBuffer(),glType:null}),this._elements.glType=function(e){if(e instanceof Int8Array)return c.BYTE;if(e instanceof Uint8Array)return c.UNSIGNED_BYTE;if(e instanceof Uint8ClampedArray)return c.UNSIGNED_BYTE;if(e instanceof Int16Array)return c.SHORT;if(e instanceof Uint16Array)return c.UNSIGNED_SHORT;if(e instanceof Int32Array)return c.INT;if(e instanceof Uint32Array)return c.UNSIGNED_INT;if(e instanceof Float32Array)return c.FLOAT;throw new Error("unsupported typed array type")}(r),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._elements.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,r,t[(e.elements.storeType||"STATIC")+"_DRAW"])}return this}destroy(){for(const e in this._attribs)this._gl.deleteBuffer(this._attribs[e].buffer);this._attribs={},this._elements&&(this._gl.deleteBuffer(this._elements.buffer),this._elements=void 0)}}function $(e,t){if(e===t)return!0;if(!t||!e)return!1;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}let K=1;class Q{constructor(e,t="Frame"+K++){this._gl=e,this.id=t,this.width=0,this.height=0,this.layers=[],this._data={},this._targets=[],this._textures=[]}image(e=0){return this._targets.length&&this._targets[this._targets.length-1].textures[e]||this._textures[e]}update(e){const t=this._gl,r=Array.isArray(e.layers)?e.layers:e.layers?[e.layers]:this.layers,n=e.selfReferencing||this._data.selfReferencing,i=r.reduce((e,t)=>e+(t._uniforms.length||1),0),s=n||i>1?2:i,a=e.width||this._data.width||t.drawingBufferWidth,o=e.height||this._data.width||t.drawingBufferHeight;return s===this._targets.length&&$(this._data.bufferStructure,e.bufferStructure)||this._destroyTargets(),!this._targets.length&&s>0?(this._targets=function(e,t,r=[]){for(let n=0;n<t;n++)r[n]=e(n);return r}(t=>({id:this.id+"_target"+(t+1),width:a,height:o,frameBuffer:null,textures:[],depthBuffer:null,bufferStructure:e.bufferStructure||["UNSIGNED_BYTE"]}),s),e.wrap||e.wrapS||e.wrapT||(e.wrap=E.wrap),e.minFilter||(e.minFilter=E.minFilter),e.magFilter||(e.magFilter=E.magFilter),this._targets.forEach(r=>Y(t,r,e,this._data))):!this._targets.length||a===this.width&&o===this.height||this._targets.forEach(r=>{r.width=a,r.height=o,Y(t,r,e,this._data)}),e.asset&&(null==this._textures[0]&&(this._textures[0]=t.createTexture()),t.bindTexture(t.TEXTURE_2D,this._textures[0]),e.wrap||e.wrapS||e.wrapT||(e.wrap=E.wrap),e.minFilter||(e.minFilter=E.minFilter),e.magFilter||(e.magFilter=E.magFilter),V(t,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.asset),e.minFilter&&e.minFilter.indexOf("MIPMAP")>0&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)),Object.assign(this._data,e),this.layers=r,this.width=a,this.height=o,this}destroy(){this._destroyTargets(),this._textures.forEach(e=>{null!=e&&this._gl.deleteTexture(e)}),this._textures=[],this._data={},this.layers=[],this.width=0,this.height=0}_destroyTargets(){this._targets.forEach(e=>(function(e,t){e.deleteFramebuffer(t.frameBuffer),e.deleteRenderbuffer(t.depthBuffer);for(const r of t.textures)e.deleteTexture(r)})(this._gl,e)),this._targets=[]}_swapTargets(){if(this._targets.length>1){const e=this._targets[0];this._targets[0]=this._targets[1],this._targets[1]=e}}}let q=1;class J{constructor(e="DrawingLayer"+q++){this.id=e,this.sketches=[],this._data={},this._uniforms=[]}update(e){if(e.sketches&&(this.sketches=Array.isArray(e.sketches)?e.sketches:[e.sketches]),e.frag){const t=this.sketches&&this.sketches[0];t&&t.shade.update({frag:e.frag})}return e.uniforms&&(this._uniforms=Array.isArray(e.uniforms)?e.uniforms:[e.uniforms]),Object.assign(this._data,e),this}destroy(){for(const e of this.sketches)e.destroy()}}let Z=1;class ee{constructor(e,t="Shade"+Z++){this.gl=e,this.id=t}update(e){const t=this.gl,r=e.frag&&e.frag.trim()||this.fragSource,n=e.vert&&e.vert.trim()||this.vertSource;if(!r||!n||r===this.fragSource&&n===this.vertSource)return this;this.destroy(),r.indexOf("GL_EXT_draw_buffers")>=0&&t.getExtension("WEBGL_draw_buffers");const i=t.createProgram(),s=t.createShader(t.FRAGMENT_SHADER),a=t.createShader(t.VERTEX_SHADER);if(i&&a&&s){if(this._program=i,this._frag=s,this._vert=a,t.attachShader(i,a),t.attachShader(i,s),t.shaderSource(a,n),t.shaderSource(s,r),t.compileShader(a),t.compileShader(s),t.getShaderParameter(a,t.COMPILE_STATUS)||console.error("Error Compiling Vertex Shader!\n",t.getShaderInfoLog(a),te(n)),t.getShaderParameter(s,t.COMPILE_STATUS)||console.error("Error Compiling Fragment Shader!\n",t.getShaderInfoLog(s),te(r)),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS)){const e=t.getProgramInfoLog(i);console.error("Error in program linking:",e)}return this._uniformSetters=function(e,t){let r=0;function n(t,n){const i=e.getUniformLocation(t,n.name),s=n.size>1&&"[0]"===n.name.substr(-3),a=n.type,o=z[a];if(!o)throw new Error("unknown type: 0x"+a.toString(16));if(null==i)return;let u;if(null===o.Type){const t=r;r+=n.size,u=s?o.arraySetter(e,a,t,i,n.size):o.setter(e,a,t,i)}else u=o.arraySetter&&s?o.arraySetter(e,i):o.setter(e,i);return{setter:u,location:i}}const i={},s=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let r=0;r<s;++r){const s=e.getActiveUniform(t,r);if(!s)continue;let a=s.name;if("[0]"===a.substr(-3)&&(a=a.substr(0,a.length-3)),t){const e=n(t,s);e&&(i[a]=e)}}return i}(t,i),this._attributeSetters=function(e,t){const r={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let i=0;i<n;i++){const n=e.getActiveAttrib(t,i);if(!n)break;const s=e.getAttribLocation(t,n.name),a=X[n.type],o=a.setter(e,s,a);r[n.name]={setter:o,location:s}}return r}(t,i),this.fragSource=r,this.vertSource=n,this}}destroy(){this.gl.deleteProgram(this._program),this.gl.deleteShader(this._frag),this.gl.deleteShader(this._vert),this.vertSource=void 0,this.fragSource=void 0,this._attributeSetters={},this._uniformSetters={}}}function te(e){return e.trim().split("\n").map((e,t)=>t+1+": "+e).join("\n")}let re=1;class ne{constructor(e="Sketch"+re++){this.id=e,this._uniforms=[]}update(e){return e.drawSettings&&(this._drawSettings=e.drawSettings),e.form&&(this.form=e.form),e.shade&&(this.shade=e.shade),e.uniforms&&(this._uniforms=Array.isArray(e.uniforms)?e.uniforms:[e.uniforms]),this}destroy(){this.form&&this.form.destroy(),this.shade&&this.shade.destroy(),this._drawSettings=void 0,this._uniforms=[]}}class ie{constructor(e,{multiplier:t=1}={}){this.gl=e,this.resize({multiplier:t}),k(this.gl,h(this.gl)),this._renderQuad=this.createForm().update(d.renderQuad),this._staticSketch=this.createFlatSketch()}resize({multiplier:e=1}={}){return y(this.gl.canvas,e),this}destroy(){this._staticSketch.destroy(),this._renderQuad.destroy()}updateDrawSettings(e){return k(this.gl,Object.assign({},e)),this}createForm(e){return new j(this.gl,e)}createShade(e){return new ee(this.gl,e)}createSketch(e){return new ne(e)}createFlatSketch(e){const t=this.createSketch(e);return t.update({form:this._renderQuad,shade:this.createShade(t.id+"_defaultShade").update(A.basicEffect)})}createFrame(e){return new Q(this.gl,e)}createLayer(e){return new J(e)}createEffect(e){const t=this.createLayer(e);return t.update({sketches:this.createFlatSketch(t.id+"_effectSketch")})}draw(e,t){const r=this.gl;return r.bindFramebuffer(r.FRAMEBUFFER,null),r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),se(r,e,t),this}compose(...e){for(const t of e)fe(this.gl,t);return this}display(e,t=0){return this.draw(this._staticSketch,{source:e.image(t)})}}function se(e,t,r,n){const{shade:i,form:s,_drawSettings:a,_uniforms:o}=t;if(!i||!s)throw Error("cannot draw, shader or geometry are not set");e.useProgram(i._program),function(e,t){for(const r in t._attribs){const n=e._attributeSetters[r];n&&n.setter(t._attribs[r])}}(i,s),r&&oe(i,r,n),a&&k(e,a);for(let r=0;r<(o.length||1);r++)ae(e,t,o[r],n);a&&H(e,a)}function ae(e,t,r,n){r&&oe(t.shade,r,n),t.form._elements&&null!=t.form._elements.glType?(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.form._elements.buffer),e.drawElements(t.form._drawType,t.form._itemCount,t.form._elements.glType,0)):e.drawArrays(t.form._drawType,0,t.form._itemCount)}function oe(e,t,r){for(const n in t){const i=e._uniformSetters[n];if(i){let e=t[n];"function"==typeof e&&(e=e()),"string"==typeof e&&r?i.setter(r[e]):i.setter(e)}}}function ue(e,t,r,n,i){n?(e.bindFramebuffer(e.FRAMEBUFFER,n.frameBuffer),e.viewport(0,0,n.width,n.height)):(e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)),t._data.drawSettings&&k(e,t._data.drawSettings);for(const n of t.sketches)se(e,n,r,i);t._data.drawSettings&&H(e,t._data.drawSettings)}function fe(e,t){for(let r=0;r<t.layers.length;r++){const n=t.layers[r],i=n._uniforms.length||1;for(let s=0;s<i;s++){const i=t._targets[0],a=r+s===0&&t._textures.length?t._textures:t._targets[1]&&t._targets[1].textures;ue(e,n,n._uniforms[s],i,a),t._swapTargets()}}}r.d(t,"utils",function(){return _e}),r.d(t,"lib",function(){return le}),r.d(t,"constants",function(){return Te}),r.d(t,"Painter",function(){return ie});const _e={geometry:{plane:a},stackgl:o,context:s},le=i,Te=n}])});