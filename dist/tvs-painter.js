!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.tvsPainter=e():t.tvsPainter=e()}(window,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);var i={};r.r(i),r.d(i,"GEOMETRY_PROP_POSITION",function(){return o}),r.d(i,"GEOMETRY_PROP_NORMAL",function(){return f}),r.d(i,"GEOMETRY_PROP_UV",function(){return _}),r.d(i,"UNIFORM_SOURCE_TEXTURE",function(){return h}),r.d(i,"VARYING_UV_COORDS",function(){return T}),r.d(i,"GL_TYPE",function(){return l}),r.d(i,"TEXTURE_FORMAT",function(){return E}),r.d(i,"TEXTURE_FORMAT_INTERNAL",function(){return c}),r.d(i,"TEXTURE_FORMAT_DEFAULTS",function(){return d});var n={};r.r(n),r.d(n,"defaultTextureSettings",function(){return R}),r.d(n,"getDefaultLayerSettings",function(){return A}),r.d(n,"defaultForms",function(){return S}),r.d(n,"defaultShaders",function(){return m});var s={};r.r(s),r.d(s,"makeClear",function(){return y}),r.d(s,"setBlendFunc",function(){return p}),r.d(s,"resizeCanvas",function(){return g});var a={};r.r(a),r.d(a,"plane",function(){return F});var u={};r.r(u),r.d(u,"STACK_GL_GEOMETRY_PROP_POSITION",function(){return N}),r.d(u,"STACK_GL_GEOMETRY_PROP_NORMAL",function(){return U}),r.d(u,"STACK_GL_GEOMETRY_PROP_UV",function(){return I}),r.d(u,"STACK_GL_GEOMETRY_PROP_ELEMENTS",function(){return O}),r.d(u,"convertStackGLGeometry",function(){return G});const o="position",f="normal",_="uv",h="source",T="coords",l={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FLOAT_MAT2X3:35685,FLOAT_MAT2X4:35686,FLOAT_MAT3X2:35687,FLOAT_MAT3X4:35688,FLOAT_MAT4X2:35689,FLOAT_MAT4X3:35690,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879,TEXTURE_2D_ARRAY:35866,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042},E={RED:6403,RG:33319,RGB:6407,RGBA:6408,RED_INTEGER:36244,RG_INTEGER:33320,RGB_INTEGER:36248,RGBA_INTEGER:36249,DEPTH_COMPONENT:6402},c={R8:33321,RG8:33323,RGB8:32849,RGBA8:32856,R16F:33325,RG16F:33327,RGB16F:34843,RGBA16F:34842,R32F:33326,RG32F:33328,RGB32F:34837,RGBA32F:34836,R8I:33329,RG8I:33335,RGB8I:36239,RGBA8I:36238,R8UI:33330,RG8UI:33336,RGB8UI:36221,RGBA8UI:36220,R16I:33331,RG16I:33337,RGB16I:36233,RGBA16I:36232,R16UI:33332,RG16UI:33338,RGB16UI:36215,RGBA16UI:36214,R32I:33333,RG32I:33339,RGB32I:36227,RGBA32I:36226,R32UI:33334,RG32UI:33340,RGB32UI:36209,RGBA32UI:36208,RGB10_A2:32857,RGB10_A2UI:36975,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,DEPTH_COMPONENT16:33189,DEPTH_COMPONENT24:33190,DEPTH_COMPONENT32F:36012},d={[l.UNSIGNED_BYTE]:{[E.RED]:c.R8,[E.RG]:c.RG8,[E.RGB]:c.RGB8,[E.RGBA]:c.RGBA8},[l.UNSIGNED_SHORT]:{[E.DEPTH_COMPONENT]:c.DEPTH_COMPONENT16,[E.RED]:c.R16UI,[E.RG]:c.RG16UI,[E.RGB]:c.RGB16UI,[E.RGBA]:c.RGBA16UI},[l.UNSIGNED_INT]:{[E.DEPTH_COMPONENT]:c.DEPTH_COMPONENT24,[E.RED]:c.R32UI,[E.RG]:c.RG32UI,[E.RGB]:c.RGB32UI,[E.RGBA]:c.RGBA32UI},[l.FLOAT]:{[E.RED]:c.R16F,[E.RG]:c.RG16F,[E.RGB]:c.RGB16F,[E.RGBA]:c.RGBA16F,[E.DEPTH_COMPONENT]:c.DEPTH_COMPONENT32F},COMPRESSED_TYPES:{}},R={wrap:"CLAMP_TO_EDGE",minFilter:"LINEAR",magFilter:"NEAREST"};function A(t){return{clearColor:[0,0,0,1],blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]}}const S={renderQuad:{attribs:{[o]:{buffer:new Float32Array([-1,1,-1,-1,1,1,1,-1]),storeType:"STATIC"},[_]:{buffer:new Float32Array([0,1,0,0,1,1,1,0]),storeType:"STATIC"}},drawType:"TRIANGLE_STRIP",itemCount:4}},m={basicEffect:{vert:`\nattribute vec2 ${o};\nattribute vec2 ${_};\nvarying vec2 ${T};\nvoid main() {\n\t${T} = ${_};\n\tgl_Position = vec4(${o}, 0.0, 1.0);\n}`,frag:`precision mediump float;\nuniform sampler2D ${h};\nvarying vec2 ${T};\nvoid main() {\n\tgl_FragColor = texture2D(${h}, ${T});\n}`}};function y(t,...e){return e.reduce((e,r)=>e|t[r.toUpperCase()+"_BUFFER_BIT"],0)}function p(t,e){t.blendFunc.apply(t,e.map(e=>t[e.toUpperCase()]))}function g(t,e=1){const r=t.clientWidth*e|0,i=t.clientHeight*e|0;return(t.width!==r||t.height!==i)&&(t.width=r,t.height=i,!0)}function F(t,e,r,i){const n=t/2,s=e/2,a=r||1,u=i||1,o=a+1,f=u+1,_=t/a,h=e/u,T=new Float32Array(o*f*3),l=new Float32Array(o*f*3),E=new Float32Array(o*f*2);let c,d,R=0,A=0;for(c=0;c<f;c++){const t=c*h-s;for(d=0;d<o;d++){const e=d*_-n;T[R]=e,T[R+1]=-t,l[R+2]=1,E[A]=d/a,E[A+1]=1-c/u,R+=3,A+=2}}R=0;const S=new(T.length/3>65535?Uint32Array:Uint16Array)(a*u*6);for(c=0;c<u;c++)for(d=0;d<a;d++){const t=d+o*c,e=d+o*(c+1),r=d+1+o*(c+1),i=d+1+o*c;S[R]=t,S[R+1]=e,S[R+2]=i,S[R+3]=e,S[R+4]=r,S[R+5]=i,R+=6}return{attribs:{position:{buffer:T},normal:{buffer:l},uv:{buffer:E}},elements:{buffer:S},drawType:"TRIANGLES",itemCount:S.length}}function b(t,e=[]){for(const r of t){const t=e.length;for(let i=0;i<r.length;i++)e[i+t]=r[i]}return e}const N="positions",U="normals",I="uvs",O="cells";function G(t){const e={drawType:"TRIANGLES",attribs:{},itemCount:0};for(const r in t){const i=t[r];if(r===O){const t=new(i.length>65535?Uint32Array:Uint16Array)(b(i));Object.assign(e,{elements:{buffer:t},itemCount:t.length})}else r===N?e.attribs[o]={buffer:new Float32Array(b(i))}:r===U?e.attribs[f]={buffer:new Float32Array(b(i))}:r===I?e.attribs[_]={buffer:new Float32Array(b(i))}:e.attribs[r]={buffer:new Float32Array(b(i))}}return e}function B(t){return z[t].bindPoint}function L(t,e){return r=>{t.uniform1i(e,r)}}function P(t,e){return r=>{t.uniform1iv(e,r)}}function M(t,e){return r=>{t.uniform2iv(e,r)}}function D(t,e){return r=>{t.uniform3iv(e,r)}}function w(t,e){return r=>{t.uniform4iv(e,r)}}function C(t,e,r,i){const n=B(e);return e=>{t.uniform1i(i,r),t.activeTexture(t.TEXTURE0+r),t.bindTexture(n,e._texture)}}function x(t,e,r,i,n){const s=B(e),a=new Int32Array(n);for(let t=0;t<n;++t)a[t]=r+t;return e=>{t.uniform1iv(i,a);for(const r in e)t.activeTexture(t.TEXTURE0+a[r]),t.bindTexture(s,e[r]._texture)}}const z={[l.FLOAT]:{Type:Float32Array,size:4,setter:function(t,e){return r=>{t.uniform1f(e,r)}},arraySetter:function(t,e){return r=>{t.uniform1fv(e,r)}}},[l.FLOAT_VEC2]:{Type:Float32Array,size:8,setter:function(t,e){return r=>{t.uniform2fv(e,r)}}},[l.FLOAT_VEC3]:{Type:Float32Array,size:12,setter:function(t,e){return r=>{t.uniform3fv(e,r)}}},[l.FLOAT_VEC4]:{Type:Float32Array,size:16,setter:function(t,e){return r=>{t.uniform4fv(e,r)}}},[l.INT]:{Type:Int32Array,size:4,setter:L,arraySetter:P},[l.INT_VEC2]:{Type:Int32Array,size:8,setter:M},[l.INT_VEC3]:{Type:Int32Array,size:12,setter:D},[l.INT_VEC4]:{Type:Int32Array,size:16,setter:w},[l.UNSIGNED_INT]:{Type:Uint32Array,size:4,setter:function(t,e){return r=>{t.uniform1ui(e,r)}},arraySetter:function(t,e){return r=>{t.uniform1uiv(e,r)}}},[l.UNSIGNED_INT_VEC2]:{Type:Uint32Array,size:8,setter:function(t,e){return r=>{t.uniform2uiv(e,r)}}},[l.UNSIGNED_INT_VEC3]:{Type:Uint32Array,size:12,setter:function(t,e){return r=>{t.uniform3uiv(e,r)}}},[l.UNSIGNED_INT_VEC4]:{Type:Uint32Array,size:16,setter:function(t,e){return r=>{t.uniform4uiv(e,r)}}},[l.BOOL]:{Type:Uint32Array,size:4,setter:L,arraySetter:P},[l.BOOL_VEC2]:{Type:Uint32Array,size:8,setter:M},[l.BOOL_VEC3]:{Type:Uint32Array,size:12,setter:D},[l.BOOL_VEC4]:{Type:Uint32Array,size:16,setter:w},[l.FLOAT_MAT2]:{Type:Float32Array,size:16,setter:function(t,e){return r=>{t.uniformMatrix2fv(e,!1,r)}}},[l.FLOAT_MAT3]:{Type:Float32Array,size:36,setter:function(t,e){return r=>{t.uniformMatrix3fv(e,!1,r)}}},[l.FLOAT_MAT4]:{Type:Float32Array,size:64,setter:function(t,e){return r=>{t.uniformMatrix4fv(e,!1,r)}}},[l.FLOAT_MAT2X3]:{Type:Float32Array,size:24,setter:function(t,e){return r=>{t.uniformMatrix2x3fv(e,!1,r)}}},[l.FLOAT_MAT2X4]:{Type:Float32Array,size:32,setter:function(t,e){return r=>{t.uniformMatrix2x4fv(e,!1,r)}}},[l.FLOAT_MAT3X2]:{Type:Float32Array,size:24,setter:function(t,e){return r=>{t.uniformMatrix3x2fv(e,!1,r)}}},[l.FLOAT_MAT3X4]:{Type:Float32Array,size:48,setter:function(t,e){return r=>{t.uniformMatrix3x4fv(e,!1,r)}}},[l.FLOAT_MAT4X2]:{Type:Float32Array,size:32,setter:function(t,e){return r=>{t.uniformMatrix4x2fv(e,!1,r)}}},[l.FLOAT_MAT4X3]:{Type:Float32Array,size:48,setter:function(t,e){return r=>{t.uniformMatrix4x3fv(e,!1,r)}}},[l.SAMPLER_2D]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D},[l.SAMPLER_CUBE]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_CUBE_MAP},[l.SAMPLER_3D]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_3D},[l.SAMPLER_2D_SHADOW]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D},[l.SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D_ARRAY},[l.SAMPLER_2D_ARRAY_SHADOW]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D_ARRAY},[l.SAMPLER_CUBE_SHADOW]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_CUBE_MAP},[l.INT_SAMPLER_2D]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D},[l.INT_SAMPLER_3D]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_3D},[l.INT_SAMPLER_CUBE]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_CUBE_MAP},[l.INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D_ARRAY},[l.UNSIGNED_INT_SAMPLER_2D]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D},[l.UNSIGNED_INT_SAMPLER_3D]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_3D},[l.UNSIGNED_INT_SAMPLER_CUBE]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_CUBE_MAP},[l.UNSIGNED_INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:C,arraySetter:x,bindPoint:l.TEXTURE_2D_ARRAY}};function v(t,e,r){return i=>{t.bindBuffer(t.ARRAY_BUFFER,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.itemSize,l.FLOAT,i.normalize||!1,i.stride||0,i.offset||0)}}function X(t,e,r){return i=>{t.bindBuffer(t.ARRAY_BUFFER,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.itemSize,l.INT,i.stride||0,i.offset||0)}}function V(t,e,r){const i=r.size,n=r.count;return r=>{t.bindBuffer(t.ARRAY_BUFFER,r.buffer);const s=i,a=s/n,u=z[l.FLOAT].size*s,o=r.normalize||!1,f=r.offset||0,_=u/n;for(let r=0;r<n;++r)t.enableVertexAttribArray(e+r),t.vertexAttribPointer(e+r,a,l.FLOAT,o,u,f+_*r)}}const Y={[l.FLOAT]:{size:4,setter:v,itemSize:1},[l.FLOAT_VEC2]:{size:8,setter:v,itemSize:2},[l.FLOAT_VEC3]:{size:12,setter:v,itemSize:3},[l.FLOAT_VEC4]:{size:16,setter:v,itemSize:4},[l.INT]:{size:4,setter:X,itemSize:1},[l.INT_VEC2]:{size:8,setter:X,itemSize:2},[l.INT_VEC3]:{size:12,setter:X,itemSize:3},[l.INT_VEC4]:{size:16,setter:X,itemSize:4},[l.UNSIGNED_INT]:{size:4,setter:X,itemSize:1},[l.UNSIGNED_INT_VEC2]:{size:8,setter:X,itemSize:2},[l.UNSIGNED_INT_VEC3]:{size:12,setter:X,itemSize:3},[l.UNSIGNED_INT_VEC4]:{size:16,setter:X,itemSize:4},[l.BOOL]:{size:4,setter:X,itemSize:1},[l.BOOL_VEC2]:{size:8,setter:X,itemSize:2},[l.BOOL_VEC3]:{size:12,setter:X,itemSize:3},[l.BOOL_VEC4]:{size:16,setter:X,itemSize:4},[l.FLOAT_MAT2]:{size:4,setter:V,count:2},[l.FLOAT_MAT3]:{size:9,setter:V,count:3},[l.FLOAT_MAT4]:{size:16,setter:V,count:4}};Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array,Uint16Array,Uint16Array,Uint16Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array;function H(t,e){if(e.enable)for(const r of e.enable)t.enable(r);if(e.disable)for(const r of e.disable)t.disable(r);e.blendFunc&&t.blendFunc.apply(t,e.blendFunc),null!=e.depthFunc&&t.depthFunc(e.depthFunc),null!=e.cullFace&&t.cullFace(e.cullFace),null!=e.frontFace&&t.frontFace(e.frontFace),null!=e.lineWidth&&t.lineWidth(e.lineWidth),e.colorMask&&t.colorMask.apply(t,e.colorMask),null!=e.depthMask&&t.depthMask(e.depthMask),e.clearColor&&t.clearColor.apply(t,e.clearColor),null!=e.clearDepth&&t.clearDepth(e.clearDepth),null!=e.clearBits&&t.clear(e.clearBits)}function k(t,e){if(e.enable)for(const r of e.enable)t.disable(r);if(e.disable)for(const r of e.disable)t.enable(r)}let W=1;class j{constructor(t,e="Form"+W++){this._painter=t,this.id=e}update(t){const e=this._painter.gl;t.drawType&&(this._drawType=e[t.drawType]),t.itemCount&&(this._itemCount=t.itemCount),this._attribs=this._attribs||{};for(const r in t.attribs){const i=t.attribs[r];null==this._attribs[r]&&(this._attribs[r]={buffer:e.createBuffer()}),e.bindBuffer(e.ARRAY_BUFFER,this._attribs[r].buffer),e.bufferData(e.ARRAY_BUFFER,i.buffer,e[(i.storeType||"STATIC")+"_DRAW"])}if(t.elements){const r=t.elements.buffer;null==this._elements&&(this._elements={buffer:e.createBuffer(),glType:null}),this._elements.glType=function(t){if(t instanceof Int8Array)return l.BYTE;if(t instanceof Uint8Array)return l.UNSIGNED_BYTE;if(t instanceof Uint8ClampedArray)return l.UNSIGNED_BYTE;if(t instanceof Int16Array)return l.SHORT;if(t instanceof Uint16Array)return l.UNSIGNED_SHORT;if(t instanceof Int32Array)return l.INT;if(t instanceof Uint32Array)return l.UNSIGNED_INT;if(t instanceof Float32Array)return l.FLOAT;throw new Error("unsupported typed array type")}(r),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._elements.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e[(t.elements.storeType||"STATIC")+"_DRAW"])}return this}destroy(){const t=this._painter.gl;for(const e in this._attribs)t.deleteBuffer(this._attribs[e].buffer);this._attribs={},this._elements&&(t.deleteBuffer(this._elements.buffer),this._elements=void 0)}}let $=1;class K{constructor(t,e="Texture"+$++){this._painter=t,this.id=e,this._texture=null,this._data={}}update(t){const e=this._painter.gl;if(null==this._texture&&(this._texture=e.createTexture()),e.bindTexture(e.TEXTURE_2D,this._texture),t.wrap&&t.wrap!==this._data.wrap||t.wrapS&&t.wrapS!==this._data.wrapS||t.wrapT&&t.wrapT!==this._data.wrapT){let r,i;t.wrap?r=i=t.wrap:(i=t.wrapT||R.wrap,r=t.wrapS||R.wrap),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[r]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[i])}else this._data.wrap||this._data.wrapS||this._data.wrapT||(this._data.wrap=this._data.wrapT=this._data.wrapS=R.wrap,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[this._data.wrap]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[this._data.wrap]));return t.magFilter&&t.magFilter!==this._data.magFilter?e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[t.magFilter]):this._data.magFilter||(this._data.magFilter=R.magFilter,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[this._data.magFilter])),t.minFilter&&t.minFilter!==this._data.minFilter?e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[t.minFilter]):this._data.minFilter||(this._data.minFilter=R.minFilter,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[this._data.minFilter])),t.asset&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.asset),void 0!==t.data&&e.texImage2D(e.TEXTURE_2D,0,"FLOAT"===t.type&&this._painter.isWebGL2?e.RGBA32F:e.RGBA,t.width,t.height,0,e.RGBA,e[t.type||"UNSIGNED_BYTE"],t.data),null!=t.flipY&&t.flipY!==this._data.flipY&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY),t.minFilter&&t.minFilter.indexOf("MIPMAP")>0&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),Object.assign(this._data,t),this}destroy(){this._painter.gl.deleteTexture(this._texture),this._data={},this._texture=null}}let Q=1;class q{constructor(t,e="Form"+Q++){this._painter=t,this.id=e,this.width=0,this.height=0,this.frameBuffer=null,this.textures=[],this.depthBuffer=null,this.bufferStructure=[],this._data={}}update(t){const e=this._painter.gl,r=t.width||this.width,i=t.height||this.height;if(!r||!i)return this;if(r===this.width&&i===this.height){if(!t.bufferStructure)return this;if(t.bufferStructure.length===this.bufferStructure.length&&this.bufferStructure.every((e,r)=>(function(t,e){if(t===e)return!0;if(!e)return!1;const r=Object.keys(t);if(!function(t,e){if(t===e)return!0;if(!e||!t)return!1;if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}(r,Object.keys(e)))return!1;for(const i of r)if(t[i]!==e[i])return!1;return!0})(e,t.bufferStructure[r])))return this}null==this.frameBuffer&&(this.frameBuffer=e.createFramebuffer()),e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),t.bufferStructure&&t.bufferStructure.length&&(this.bufferStructure=t.bufferStructure,this.bufferStructure.some(t=>"FLOAT"===t.type)&&(this._painter.isWebGL2?e.getExtension("EXT_color_buffer_float"):e.getExtension("OES_texture_float")));const n=this.bufferStructure.length||1,s=[e.COLOR_ATTACHMENT0];if(n>1){let t;this._painter.isWebGL2||(t=e.getExtension("WEBGL_draw_buffers"));const r=this._painter.isWebGL2?e.COLOR_ATTACHMENT0:t.COLOR_ATTACHMENT0_WEBGL;for(let t=0;t<n;t++)s[t]=r+t;this._painter.isWebGL2?e.drawBuffers(s):t.drawBuffersWEBGL(s)}for(let t=0;t<n;t++){this.textures[t]||(this.textures[t]=new K(this._painter,this.id+"_Texture"+t));const n=this.textures[t];n.update(Object.assign({minFilter:"NEAREST",magFilter:"NEAREST"},this.bufferStructure[t],{data:null,width:r,height:i})),e.framebufferTexture2D(e.FRAMEBUFFER,s[t],e.TEXTURE_2D,n._texture,0)}null==this.depthBuffer&&(this.depthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,r,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer);const a=e.checkFramebufferStatus(e.FRAMEBUFFER);return a!==e.FRAMEBUFFER_COMPLETE&&console.error("framebuffer error",a,t),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),Object.assign(this._data,t),this.width=r,this.height=i,this}destroy(){const t=this._painter.gl;t.deleteFramebuffer(this.frameBuffer),t.deleteRenderbuffer(this.depthBuffer);for(const e of this.textures)t.deleteTexture(e);this.textures=[],this.frameBuffer=null,this.depthBuffer=null,this._data={},this.bufferStructure=[],this.width=0,this.height=0}}let J=1;class Z{constructor(t,e="Frame"+J++){this._painter=t,this.id=e,this.width=0,this.height=0,this.layers=[],this._data={},this._targets=[],this._textures=[]}image(t=0){return this._targets.length&&this._targets[this._targets.length-1].textures[t]||this._textures[t]}update(t){const e=this._painter.gl,r=Array.isArray(t.layers)?t.layers:t.layers?[t.layers]:this.layers,i=t.selfReferencing||this._data.selfReferencing,n=r.reduce((t,e)=>t+(e._uniforms.length||1),0),s=i||n>1?2:n;return t.width=t.width||this.width||e.drawingBufferWidth,t.height=t.height||this.width||e.drawingBufferHeight,s!==this._targets.length&&this._destroyTargets(),!this._targets.length&&s>0?this._targets=function(t,e,r=[]){for(let i=0;i<e;i++)r[i]=t(i);return r}(e=>new q(this._painter,this.id+"_target"+(e+1)).update(t),s):this._targets.length&&this._targets.forEach(e=>{e.update(t)}),t.texture&&(this._textures[0]||(this._textures[0]=new K(this._painter,this.id+"_Texture0")),t.texture.width=t.texture.width||t.width,t.texture.height=t.texture.height||t.height,this._textures[0].update(t.texture)),Object.assign(this._data,t),this.layers=r,this.width=t.width,this.height=t.height,this}destroy(){this._destroyTargets(),this._textures.forEach(t=>t.destroy()),this._textures=[],this._data={},this.layers=[],this.width=0,this.height=0}_destroyTargets(){this._targets.forEach(t=>t.destroy()),this._targets=[]}_swapTargets(){if(this._targets.length>1){const t=this._targets[0];this._targets[0]=this._targets[1],this._targets[1]=t}}}let tt=1;class et{constructor(t="DrawingLayer"+tt++){this.id=t,this.sketches=[],this._data={},this._uniforms=[]}update(t){if(t.sketches&&(this.sketches=Array.isArray(t.sketches)?t.sketches:[t.sketches]),t.frag){const e=this.sketches&&this.sketches[0];e&&e.shade.update({frag:t.frag})}return t.uniforms&&(this._uniforms=Array.isArray(t.uniforms)?t.uniforms:[t.uniforms]),Object.assign(this._data,t),this}destroy(){for(const t of this.sketches)t.destroy();this._data.sketches=[],this._data={},this._uniforms=[]}}let rt=1;class it{constructor(t,e="Shade"+rt++){this._painter=t,this.id=e}update(t){const e=this._painter.gl,r=t.frag&&t.frag.trim()||this.fragSource,i=t.vert&&t.vert.trim()||this.vertSource;if(!r||!i||r===this.fragSource&&i===this.vertSource)return this;this.destroy(),r.indexOf("GL_EXT_draw_buffers")>=0&&e.getExtension("WEBGL_draw_buffers");const n=e.createProgram(),s=e.createShader(e.FRAGMENT_SHADER),a=e.createShader(e.VERTEX_SHADER);if(n&&a&&s){if(this._program=n,this._frag=s,this._vert=a,e.attachShader(n,a),e.attachShader(n,s),e.shaderSource(a,i),e.shaderSource(s,r),e.compileShader(a),e.compileShader(s),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("Error Compiling Vertex Shader!\n",e.getShaderInfoLog(a),nt(i)),e.getShaderParameter(s,e.COMPILE_STATUS)||console.error("Error Compiling Fragment Shader!\n",e.getShaderInfoLog(s),nt(r)),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){const t=e.getProgramInfoLog(n);console.error("Error in program linking:",t)}return this._uniformSetters=function(t,e){let r=0;function i(e,i){const n=t.getUniformLocation(e,i.name),s=i.size>1&&"[0]"===i.name.substr(-3),a=i.type,u=z[a];if(!u)throw new Error("unknown type: 0x"+a.toString(16));if(null==n)return;let o;if(null===u.Type){const e=r;r+=i.size,o=s?u.arraySetter(t,a,e,n,i.size):u.setter(t,a,e,n)}else o=u.arraySetter&&s?u.arraySetter(t,n):u.setter(t,n);return{setter:o,location:n}}const n={},s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let r=0;r<s;++r){const s=t.getActiveUniform(e,r);if(!s)continue;let a=s.name;if("[0]"===a.substr(-3)&&(a=a.substr(0,a.length-3)),e){const t=i(e,s);t&&(n[a]=t)}}return n}(e,n),this._attributeSetters=function(t,e){const r={},i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let n=0;n<i;n++){const i=t.getActiveAttrib(e,n);if(!i)break;const s=t.getAttribLocation(e,i.name),a=Y[i.type],u=a.setter(t,s,a);r[i.name]={setter:u,location:s}}return r}(e,n),this.fragSource=r,this.vertSource=i,this}}destroy(){const t=this._painter.gl;t.deleteProgram(this._program),t.deleteShader(this._frag),t.deleteShader(this._vert),this.vertSource=void 0,this.fragSource=void 0,this._attributeSetters={},this._uniformSetters={}}}function nt(t){return t.trim().split("\n").map((t,e)=>e+1+": "+t).join("\n")}let st=1;class at{constructor(t="Sketch"+st++){this.id=t,this._uniforms=[]}update(t){return t.drawSettings&&(this._drawSettings=t.drawSettings),t.form&&(this.form=t.form),t.shade&&(this.shade=t.shade),t.uniforms&&(this._uniforms=Array.isArray(t.uniforms)?t.uniforms:[t.uniforms]),this}destroy(){this.form&&this.form.destroy(),this.shade&&this.shade.destroy(),this._drawSettings=void 0,this._uniforms=[]}}class ut{constructor(t,e={}){this.canvas=t,this.isWebGL2=!0,this.maxBufferSamples=0;let r=null;if(e.useWebGL1||(r=t.getContext("webgl2",e)||t.getContext("experimental-webgl2",e)),null==r&&(this.isWebGL2=!1,r=t.getContext("webgl",e)||t.getContext("experimental-webgl",e)),null==r)throw Error("Cannot initialize WebGL.");this.gl=r,this.sizeMultiplier=e.sizeMultiplier||1,this.isWebGL2&&(this.maxBufferSamples=r.getParameter(r.MAX_SAMPLES)),this.resize(),H(r,A(r)),this._renderQuad=this.createForm().update(S.renderQuad),this._staticSketch=this.createFlatSketch()}resize(){return g(this.gl.canvas,this.sizeMultiplier),this}destroy(){this._staticSketch.destroy(),this._renderQuad.destroy()}updateDrawSettings(t){return H(this.gl,Object.assign({},t)),this}createForm(t){return new j(this,t)}createShade(t){return new it(this,t)}createSketch(t){return new at(t)}createFlatSketch(t){const e=this.createSketch(t);return e.update({form:this._renderQuad,shade:this.createShade(e.id+"_defaultShade").update(m.basicEffect)})}createFrame(t){return new Z(this,t)}createLayer(t){return new et(t)}createEffect(t){const e=this.createLayer(t);return e.update({sketches:this.createFlatSketch(e.id+"_effectSketch")})}draw(t,e){const r=this.gl;return r.bindFramebuffer(r.FRAMEBUFFER,null),r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),ot(r,t,e),this}compose(...t){for(const e of t)Tt(this.gl,e);return this}display(t,e=0){return this.draw(this._staticSketch,{source:t.image(e)})}}function ot(t,e,r,i){const{shade:n,form:s,_drawSettings:a,_uniforms:u}=e;if(!n||!s)throw Error("cannot draw, shader or geometry are not set");t.useProgram(n._program),function(t,e){for(const r in e._attribs){const i=t._attributeSetters[r];i&&i.setter(e._attribs[r])}}(n,s),r&&_t(n,r,i),a&&H(t,a);for(let r=0;r<(u.length||1);r++)ft(t,e,u[r],i);a&&k(t,a)}function ft(t,e,r,i){r&&_t(e.shade,r,i),e.form._elements&&null!=e.form._elements.glType?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.form._elements.buffer),t.drawElements(e.form._drawType,e.form._itemCount,e.form._elements.glType,0)):t.drawArrays(e.form._drawType,0,e.form._itemCount)}function _t(t,e,r){for(const i in e){const n=t._uniformSetters[i];if(n){let t=e[i];"function"==typeof t&&(t=t()),"string"==typeof t&&r?n.setter(r[t]):n.setter(t)}}}function ht(t,e,r,i,n){i?(t.bindFramebuffer(t.FRAMEBUFFER,i.frameBuffer),t.viewport(0,0,i.width,i.height)):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)),e._data.drawSettings&&H(t,e._data.drawSettings);for(const i of e.sketches)ot(t,i,r,n);e._data.drawSettings&&k(t,e._data.drawSettings)}function Tt(t,e){for(let r=0;r<e.layers.length;r++){const i=e.layers[r],n=i._uniforms.length||1;for(let s=0;s<n;s++){const n=e._targets[0],a=r+s===0&&e._textures.length?e._textures:e._targets[1]&&e._targets[1].textures;ht(t,i,i._uniforms[s],n,a),e._swapTargets()}}}r.d(e,"utils",function(){return lt}),r.d(e,"lib",function(){return Et}),r.d(e,"constants",function(){return ct}),r.d(e,"Painter",function(){return ut});const lt={geometry:{plane:a},stackgl:u,context:s},Et=n,ct=i}])});