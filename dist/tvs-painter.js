!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.tvsPainter=e():t.tvsPainter=e()}(window,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);var i={};r.r(i),r.d(i,"GEOMETRY_PROP_POSITION",function(){return u}),r.d(i,"GEOMETRY_PROP_NORMAL",function(){return f}),r.d(i,"GEOMETRY_PROP_UV",function(){return _}),r.d(i,"UNIFORM_SOURCE_TEXTURE",function(){return l}),r.d(i,"VARYING_UV_COORDS",function(){return c}),r.d(i,"GL_TYPE",function(){return T});var n={};r.r(n),r.d(n,"defaultTextureSettings",function(){return h}),r.d(n,"getDefaultLayerSettings",function(){return E}),r.d(n,"defaultForms",function(){return d}),r.d(n,"defaultShaders",function(){return A});var s={};r.r(s),r.d(s,"getContext",function(){return S}),r.d(s,"makeClear",function(){return m}),r.d(s,"setBlendFunc",function(){return R}),r.d(s,"resizeCanvas",function(){return y});var a={};r.r(a),r.d(a,"plane",function(){return g});var o={};r.r(o),r.d(o,"STACK_GL_GEOMETRY_PROP_POSITION",function(){return F}),r.d(o,"STACK_GL_GEOMETRY_PROP_NORMAL",function(){return b}),r.d(o,"STACK_GL_GEOMETRY_PROP_UV",function(){return U}),r.d(o,"STACK_GL_GEOMETRY_PROP_ELEMENTS",function(){return N}),r.d(o,"convertStackGLGeometry",function(){return I});const u="position",f="normal",_="uv",l="source",c="coords",T={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FLOAT_MAT2X3:35685,FLOAT_MAT2X4:35686,FLOAT_MAT3X2:35687,FLOAT_MAT3X4:35688,FLOAT_MAT4X2:35689,FLOAT_MAT4X3:35690,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879,TEXTURE_2D_ARRAY:35866,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042},h={wrap:"CLAMP_TO_EDGE",minFilter:"LINEAR",magFilter:"NEAREST"};function E(t){return{clearColor:[0,0,0,1],blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]}}const d={renderQuad:{attribs:{[u]:{buffer:new Float32Array([-1,1,-1,-1,1,1,1,-1]),storeType:"STATIC"},[_]:{buffer:new Float32Array([0,1,0,0,1,1,1,0]),storeType:"STATIC"}},drawType:"TRIANGLE_STRIP",itemCount:4}},A={basicEffect:{vert:`\nattribute vec2 ${u};\nattribute vec2 ${_};\nvarying vec2 ${c};\nvoid main() {\n\t${c} = ${_};\n\tgl_Position = vec4(${u}, 0.0, 1.0);\n}`,frag:`precision mediump float;\nuniform sampler2D ${l};\nvarying vec2 ${c};\nvoid main() {\n\tgl_FragColor = texture2D(${l}, ${c});\n}`}};function S(t,e){const r=t.getContext("webgl2",e)||t.getContext("experimental-webgl2",e);if(null==r)throw Error("Webgl context cannot be initialized");return r}function m(t,...e){return e.reduce((e,r)=>e|t[r.toUpperCase()+"_BUFFER_BIT"],0)}function R(t,e){t.blendFunc.apply(t,e.map(e=>t[e.toUpperCase()]))}function y(t,e=1){const r=t.clientWidth*e|0,i=t.clientHeight*e|0;return(t.width!==r||t.height!==i)&&(t.width=r,t.height=i,!0)}function g(t,e,r,i){const n=t/2,s=e/2,a=r||1,o=i||1,u=a+1,f=o+1,_=t/a,l=e/o,c=new Float32Array(u*f*3),T=new Float32Array(u*f*3),h=new Float32Array(u*f*2);let E,d,A=0,S=0;for(E=0;E<f;E++){const t=E*l-s;for(d=0;d<u;d++){const e=d*_-n;c[A]=e,c[A+1]=-t,T[A+2]=1,h[S]=d/a,h[S+1]=1-E/o,A+=3,S+=2}}A=0;const m=new(c.length/3>65535?Uint32Array:Uint16Array)(a*o*6);for(E=0;E<o;E++)for(d=0;d<a;d++){const t=d+u*E,e=d+u*(E+1),r=d+1+u*(E+1),i=d+1+u*E;m[A]=t,m[A+1]=e,m[A+2]=i,m[A+3]=e,m[A+4]=r,m[A+5]=i,A+=6}return{attribs:{position:{buffer:c},normal:{buffer:T},uv:{buffer:h}},elements:{buffer:m},drawType:"TRIANGLES",itemCount:m.length}}function p(t,e=[]){for(const r of t){const t=e.length;for(let i=0;i<r.length;i++)e[i+t]=r[i]}return e}const F="positions",b="normals",U="uvs",N="cells";function I(t){const e={drawType:"TRIANGLES",attribs:{},itemCount:0};for(const r in t){const i=t[r];if(r===N){const t=new(i.length>65535?Uint32Array:Uint16Array)(p(i));Object.assign(e,{elements:{buffer:t},itemCount:t.length})}else r===F?e.attribs[u]={buffer:new Float32Array(p(i))}:r===b?e.attribs[f]={buffer:new Float32Array(p(i))}:r===U?e.attribs[_]={buffer:new Float32Array(p(i))}:e.attribs[r]={buffer:new Float32Array(p(i))}}return e}function O(t){return x[t].bindPoint}function L(t,e){return r=>{t.uniform1i(e,r)}}function D(t,e){return r=>{t.uniform1iv(e,r)}}function M(t,e){return r=>{t.uniform2iv(e,r)}}function P(t,e){return r=>{t.uniform3iv(e,r)}}function w(t,e){return r=>{t.uniform4iv(e,r)}}function C(t,e,r,i){const n=O(e);return e=>{t.uniform1i(i,r),t.activeTexture(t.TEXTURE0+r),t.bindTexture(n,e)}}function B(t,e,r,i,n){const s=O(e),a=new Int32Array(n);for(let t=0;t<n;++t)a[t]=r+t;return e=>{t.uniform1iv(i,a);for(const r in e)t.activeTexture(t.TEXTURE0+a[r]),t.bindTexture(s,e[r])}}const x={[T.FLOAT]:{Type:Float32Array,size:4,setter:function(t,e){return r=>{t.uniform1f(e,r)}},arraySetter:function(t,e){return r=>{t.uniform1fv(e,r)}}},[T.FLOAT_VEC2]:{Type:Float32Array,size:8,setter:function(t,e){return r=>{t.uniform2fv(e,r)}}},[T.FLOAT_VEC3]:{Type:Float32Array,size:12,setter:function(t,e){return r=>{t.uniform3fv(e,r)}}},[T.FLOAT_VEC4]:{Type:Float32Array,size:16,setter:function(t,e){return r=>{t.uniform4fv(e,r)}}},[T.INT]:{Type:Int32Array,size:4,setter:L,arraySetter:D},[T.INT_VEC2]:{Type:Int32Array,size:8,setter:M},[T.INT_VEC3]:{Type:Int32Array,size:12,setter:P},[T.INT_VEC4]:{Type:Int32Array,size:16,setter:w},[T.UNSIGNED_INT]:{Type:Uint32Array,size:4,setter:function(t,e){return r=>{t.uniform1ui(e,r)}},arraySetter:function(t,e){return r=>{t.uniform1uiv(e,r)}}},[T.UNSIGNED_INT_VEC2]:{Type:Uint32Array,size:8,setter:function(t,e){return r=>{t.uniform2uiv(e,r)}}},[T.UNSIGNED_INT_VEC3]:{Type:Uint32Array,size:12,setter:function(t,e){return r=>{t.uniform3uiv(e,r)}}},[T.UNSIGNED_INT_VEC4]:{Type:Uint32Array,size:16,setter:function(t,e){return r=>{t.uniform4uiv(e,r)}}},[T.BOOL]:{Type:Uint32Array,size:4,setter:L,arraySetter:D},[T.BOOL_VEC2]:{Type:Uint32Array,size:8,setter:M},[T.BOOL_VEC3]:{Type:Uint32Array,size:12,setter:P},[T.BOOL_VEC4]:{Type:Uint32Array,size:16,setter:w},[T.FLOAT_MAT2]:{Type:Float32Array,size:16,setter:function(t,e){return r=>{t.uniformMatrix2fv(e,!1,r)}}},[T.FLOAT_MAT3]:{Type:Float32Array,size:36,setter:function(t,e){return r=>{t.uniformMatrix3fv(e,!1,r)}}},[T.FLOAT_MAT4]:{Type:Float32Array,size:64,setter:function(t,e){return r=>{t.uniformMatrix4fv(e,!1,r)}}},[T.FLOAT_MAT2X3]:{Type:Float32Array,size:24,setter:function(t,e){return r=>{t.uniformMatrix2x3fv(e,!1,r)}}},[T.FLOAT_MAT2X4]:{Type:Float32Array,size:32,setter:function(t,e){return r=>{t.uniformMatrix2x4fv(e,!1,r)}}},[T.FLOAT_MAT3X2]:{Type:Float32Array,size:24,setter:function(t,e){return r=>{t.uniformMatrix3x2fv(e,!1,r)}}},[T.FLOAT_MAT3X4]:{Type:Float32Array,size:48,setter:function(t,e){return r=>{t.uniformMatrix3x4fv(e,!1,r)}}},[T.FLOAT_MAT4X2]:{Type:Float32Array,size:32,setter:function(t,e){return r=>{t.uniformMatrix4x2fv(e,!1,r)}}},[T.FLOAT_MAT4X3]:{Type:Float32Array,size:48,setter:function(t,e){return r=>{t.uniformMatrix4x3fv(e,!1,r)}}},[T.SAMPLER_2D]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D},[T.SAMPLER_CUBE]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_CUBE_MAP},[T.SAMPLER_3D]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_3D},[T.SAMPLER_2D_SHADOW]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D},[T.SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D_ARRAY},[T.SAMPLER_2D_ARRAY_SHADOW]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D_ARRAY},[T.SAMPLER_CUBE_SHADOW]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_CUBE_MAP},[T.INT_SAMPLER_2D]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D},[T.INT_SAMPLER_3D]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_3D},[T.INT_SAMPLER_CUBE]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_CUBE_MAP},[T.INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D_ARRAY},[T.UNSIGNED_INT_SAMPLER_2D]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D},[T.UNSIGNED_INT_SAMPLER_3D]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_3D},[T.UNSIGNED_INT_SAMPLER_CUBE]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_CUBE_MAP},[T.UNSIGNED_INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:C,arraySetter:B,bindPoint:T.TEXTURE_2D_ARRAY}};function z(t,e,r){return i=>{t.bindBuffer(t.ARRAY_BUFFER,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.itemSize,T.FLOAT,i.normalize||!1,i.stride||0,i.offset||0)}}function v(t,e,r){return i=>{t.bindBuffer(t.ARRAY_BUFFER,i.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.itemSize,T.INT,i.stride||0,i.offset||0)}}function G(t,e,r){const i=r.size,n=r.count;return r=>{t.bindBuffer(t.ARRAY_BUFFER,r.buffer);const s=i,a=s/n,o=x[T.FLOAT].size*s,u=r.normalize||!1,f=r.offset||0,_=o/n;for(let r=0;r<n;++r)t.enableVertexAttribArray(e+r),t.vertexAttribPointer(e+r,a,T.FLOAT,u,o,f+_*r)}}const X={[T.FLOAT]:{size:4,setter:z,itemSize:1},[T.FLOAT_VEC2]:{size:8,setter:z,itemSize:2},[T.FLOAT_VEC3]:{size:12,setter:z,itemSize:3},[T.FLOAT_VEC4]:{size:16,setter:z,itemSize:4},[T.INT]:{size:4,setter:v,itemSize:1},[T.INT_VEC2]:{size:8,setter:v,itemSize:2},[T.INT_VEC3]:{size:12,setter:v,itemSize:3},[T.INT_VEC4]:{size:16,setter:v,itemSize:4},[T.UNSIGNED_INT]:{size:4,setter:v,itemSize:1},[T.UNSIGNED_INT_VEC2]:{size:8,setter:v,itemSize:2},[T.UNSIGNED_INT_VEC3]:{size:12,setter:v,itemSize:3},[T.UNSIGNED_INT_VEC4]:{size:16,setter:v,itemSize:4},[T.BOOL]:{size:4,setter:v,itemSize:1},[T.BOOL_VEC2]:{size:8,setter:v,itemSize:2},[T.BOOL_VEC3]:{size:12,setter:v,itemSize:3},[T.BOOL_VEC4]:{size:16,setter:v,itemSize:4},[T.FLOAT_MAT2]:{size:4,setter:G,count:2},[T.FLOAT_MAT3]:{size:9,setter:G,count:3},[T.FLOAT_MAT4]:{size:16,setter:G,count:4}};Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array,Uint16Array,Uint16Array,Uint16Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array;function V(t,e={},r={}){if(null!=e.flipY&&e.flipY!==r.flipY&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY),e.wrap&&e.wrap!==r.wrap||e.wrapS&&e.wrapS!==r.wrapS||e.wrapT&&e.wrapT!==r.wrapT){let r,i;e.wrap?r=i=e.wrap:(i=e.wrapT||"CLAMP_TO_EDGE",r=e.wrapS||"CLAMP_TO_EDGE"),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t[r]),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t[i])}e.magFilter&&e.magFilter!==r.magFilter&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t[e.magFilter]),e.minFilter&&e.minFilter!==r.minFilter&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t[e.minFilter])}function Y(t,e){if(e.enable)for(const r of e.enable)t.enable(r);if(e.disable)for(const r of e.disable)t.disable(r);e.blendFunc&&t.blendFunc.apply(t,e.blendFunc),null!=e.depthFunc&&t.depthFunc(e.depthFunc),null!=e.cullFace&&t.cullFace(e.cullFace),null!=e.frontFace&&t.frontFace(e.frontFace),null!=e.lineWidth&&t.lineWidth(e.lineWidth),e.colorMask&&t.colorMask.apply(t,e.colorMask),null!=e.depthMask&&t.depthMask(e.depthMask),e.clearColor&&t.clearColor.apply(t,e.clearColor),null!=e.clearDepth&&t.clearDepth(e.clearDepth),null!=e.clearBits&&t.clear(e.clearBits)}function k(t,e){if(e.enable)for(const r of e.enable)t.disable(r);if(e.disable)for(const r of e.disable)t.enable(r)}let H=1;class W{constructor(t,e="Form"+H++){this._gl=t,this.id=e}update(t){const e=this._gl;t.drawType&&(this._drawType=e[t.drawType]),t.itemCount&&(this._itemCount=t.itemCount),this._attribs=this._attribs||{};for(const r in t.attribs){const i=t.attribs[r];null==this._attribs[r]&&(this._attribs[r]={buffer:e.createBuffer()}),e.bindBuffer(e.ARRAY_BUFFER,this._attribs[r].buffer),e.bufferData(e.ARRAY_BUFFER,i.buffer,e[(i.storeType||"STATIC")+"_DRAW"])}if(t.elements){const r=t.elements.buffer;null==this._elements&&(this._elements={buffer:e.createBuffer(),glType:null}),this._elements.glType=function(t){if(t instanceof Int8Array)return T.BYTE;if(t instanceof Uint8Array)return T.UNSIGNED_BYTE;if(t instanceof Uint8ClampedArray)return T.UNSIGNED_BYTE;if(t instanceof Int16Array)return T.SHORT;if(t instanceof Uint16Array)return T.UNSIGNED_SHORT;if(t instanceof Int32Array)return T.INT;if(t instanceof Uint32Array)return T.UNSIGNED_INT;if(t instanceof Float32Array)return T.FLOAT;throw new Error("unsupported typed array type")}(r),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._elements.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e[(t.elements.storeType||"STATIC")+"_DRAW"])}return this}destroy(){for(const t in this._attribs)this._gl.deleteBuffer(this._attribs[t].buffer);this._attribs={},this._elements&&(this._gl.deleteBuffer(this._elements.buffer),this._elements=void 0)}}function j(t,e){if(t===e)return!0;if(!e||!t)return!1;if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}let $=1;class K{constructor(t,e="Form"+$++){this.gl=t,this.id=e,this.frameBuffer=null,this.textures=[],this.depthBuffer=null,this.width=0,this.height=0,this.bufferStructure=["UNSIGNED_BYTE"],this._data={}}update(t){const e=this.gl,r=t.width||this.width,i=t.height||this.height;if(!r||!i)return this;null==this.frameBuffer&&(this.frameBuffer=e.createFramebuffer()),e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),t.bufferStructure&&t.bufferStructure.length&&(this.bufferStructure=t.bufferStructure,this.bufferStructure.some(t=>"FLOAT"===t)&&e.getExtension("EXT_color_buffer_float"));const n=this.bufferStructure.length;if(n>1){const s=[];for(let t=0;t<n;t++)s.push(e[`COLOR_ATTACHMENT${t}`]);e.drawBuffers(s);for(let a=0;a<n;a++){null==this.textures[a]&&(this.textures[a]=e.createTexture());const n=this.textures[a],o=this.bufferStructure[a];e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,"FLOAT"===o?e.RGBA32F:e.RGBA,r,i,0,e.RGBA,e[o],null),V(e,t,this._data),e.framebufferTexture2D(e.FRAMEBUFFER,s[a],e.TEXTURE_2D,n,0)}}else{null==this.textures[0]&&(this.textures[0]=e.createTexture());const n=this.textures[0];e.bindTexture(e.TEXTURE_2D,n),V(e,t,this._data),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,r,i,0,e.RGBA,e[this.bufferStructure[0]],null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0)}null==this.depthBuffer&&(this.depthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,r,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer);const s=e.checkFramebufferStatus(e.FRAMEBUFFER);return s!==e.FRAMEBUFFER_COMPLETE&&console.error("framebuffer error",s,t),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),Object.assign(this._data,t),this.width=r,this.height=i,this}destroy(){const t=this.gl;t.deleteFramebuffer(this.frameBuffer),t.deleteRenderbuffer(this.depthBuffer);for(const e of this.textures)t.deleteTexture(e);this.textures=[]}}let Q=1;class q{constructor(t,e="Frame"+Q++){this._gl=t,this.id=e,this.width=0,this.height=0,this.layers=[],this._data={},this._targets=[],this._textures=[]}image(t=0){return this._targets.length&&this._targets[this._targets.length-1].textures[t]||this._textures[t]}update(t){const e=this._gl,r=Array.isArray(t.layers)?t.layers:t.layers?[t.layers]:this.layers,i=t.selfReferencing||this._data.selfReferencing,n=r.reduce((t,e)=>t+(e._uniforms.length||1),0),s=i||n>1?2:n;return t.width=t.width||this.width||e.drawingBufferWidth,t.height=t.height||this.width||e.drawingBufferHeight,s===this._targets.length&&j(this._data.bufferStructure,t.bufferStructure)||this._destroyTargets(),!this._targets.length&&s>0?(this._targets=function(t,e,r=[]){for(let i=0;i<e;i++)r[i]=t(i);return r}(t=>new K(this._gl,this.id+"_target"+(t+1)),s),t.wrap||t.wrapS||t.wrapT||(t.wrap=h.wrap),t.minFilter||(t.minFilter=h.minFilter),t.magFilter||(t.magFilter=h.magFilter),this._targets.forEach(e=>e.update(t))):!this._targets.length||t.width===this.width&&t.height===this.height||this._targets.forEach(e=>{e.update(t)}),t.asset&&(null==this._textures[0]&&(this._textures[0]=e.createTexture()),e.bindTexture(e.TEXTURE_2D,this._textures[0]),t.wrap||t.wrapS||t.wrapT||(t.wrap=h.wrap),t.minFilter||(t.minFilter=h.minFilter),t.magFilter||(t.magFilter=h.magFilter),V(e,t),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.asset),t.minFilter&&t.minFilter.indexOf("MIPMAP")>0&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null)),Object.assign(this._data,t),this.layers=r,this.width=t.width,this.height=t.height,this}destroy(){this._destroyTargets(),this._textures.forEach(t=>{null!=t&&this._gl.deleteTexture(t)}),this._textures=[],this._data={},this.layers=[],this.width=0,this.height=0}_destroyTargets(){this._targets.forEach(t=>t.destroy()),this._targets=[]}_swapTargets(){if(this._targets.length>1){const t=this._targets[0];this._targets[0]=this._targets[1],this._targets[1]=t}}}let J=1;class Z{constructor(t="DrawingLayer"+J++){this.id=t,this.sketches=[],this._data={},this._uniforms=[]}update(t){if(t.sketches&&(this.sketches=Array.isArray(t.sketches)?t.sketches:[t.sketches]),t.frag){const e=this.sketches&&this.sketches[0];e&&e.shade.update({frag:t.frag})}return t.uniforms&&(this._uniforms=Array.isArray(t.uniforms)?t.uniforms:[t.uniforms]),Object.assign(this._data,t),this}destroy(){for(const t of this.sketches)t.destroy()}}let tt=1;class et{constructor(t,e="Shade"+tt++){this.gl=t,this.id=e}update(t){const e=this.gl,r=t.frag&&t.frag.trim()||this.fragSource,i=t.vert&&t.vert.trim()||this.vertSource;if(!r||!i||r===this.fragSource&&i===this.vertSource)return this;this.destroy(),r.indexOf("GL_EXT_draw_buffers")>=0&&e.getExtension("WEBGL_draw_buffers");const n=e.createProgram(),s=e.createShader(e.FRAGMENT_SHADER),a=e.createShader(e.VERTEX_SHADER);if(n&&a&&s){if(this._program=n,this._frag=s,this._vert=a,e.attachShader(n,a),e.attachShader(n,s),e.shaderSource(a,i),e.shaderSource(s,r),e.compileShader(a),e.compileShader(s),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("Error Compiling Vertex Shader!\n",e.getShaderInfoLog(a),rt(i)),e.getShaderParameter(s,e.COMPILE_STATUS)||console.error("Error Compiling Fragment Shader!\n",e.getShaderInfoLog(s),rt(r)),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){const t=e.getProgramInfoLog(n);console.error("Error in program linking:",t)}return this._uniformSetters=function(t,e){let r=0;function i(e,i){const n=t.getUniformLocation(e,i.name),s=i.size>1&&"[0]"===i.name.substr(-3),a=i.type,o=x[a];if(!o)throw new Error("unknown type: 0x"+a.toString(16));if(null==n)return;let u;if(null===o.Type){const e=r;r+=i.size,u=s?o.arraySetter(t,a,e,n,i.size):o.setter(t,a,e,n)}else u=o.arraySetter&&s?o.arraySetter(t,n):o.setter(t,n);return{setter:u,location:n}}const n={},s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let r=0;r<s;++r){const s=t.getActiveUniform(e,r);if(!s)continue;let a=s.name;if("[0]"===a.substr(-3)&&(a=a.substr(0,a.length-3)),e){const t=i(e,s);t&&(n[a]=t)}}return n}(e,n),this._attributeSetters=function(t,e){const r={},i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let n=0;n<i;n++){const i=t.getActiveAttrib(e,n);if(!i)break;const s=t.getAttribLocation(e,i.name),a=X[i.type],o=a.setter(t,s,a);r[i.name]={setter:o,location:s}}return r}(e,n),this.fragSource=r,this.vertSource=i,this}}destroy(){this.gl.deleteProgram(this._program),this.gl.deleteShader(this._frag),this.gl.deleteShader(this._vert),this.vertSource=void 0,this.fragSource=void 0,this._attributeSetters={},this._uniformSetters={}}}function rt(t){return t.trim().split("\n").map((t,e)=>e+1+": "+t).join("\n")}let it=1;class nt{constructor(t="Sketch"+it++){this.id=t,this._uniforms=[]}update(t){return t.drawSettings&&(this._drawSettings=t.drawSettings),t.form&&(this.form=t.form),t.shade&&(this.shade=t.shade),t.uniforms&&(this._uniforms=Array.isArray(t.uniforms)?t.uniforms:[t.uniforms]),this}destroy(){this.form&&this.form.destroy(),this.shade&&this.shade.destroy(),this._drawSettings=void 0,this._uniforms=[]}}class st{constructor(t,{multiplier:e=1}={}){this.gl=t,this.resize({multiplier:e}),Y(this.gl,E(this.gl)),this._renderQuad=this.createForm().update(d.renderQuad),this._staticSketch=this.createFlatSketch()}resize({multiplier:t=1}={}){return y(this.gl.canvas,t),this}destroy(){this._staticSketch.destroy(),this._renderQuad.destroy()}updateDrawSettings(t){return Y(this.gl,Object.assign({},t)),this}createForm(t){return new W(this.gl,t)}createShade(t){return new et(this.gl,t)}createSketch(t){return new nt(t)}createFlatSketch(t){const e=this.createSketch(t);return e.update({form:this._renderQuad,shade:this.createShade(e.id+"_defaultShade").update(A.basicEffect)})}createFrame(t){return new q(this.gl,t)}createLayer(t){return new Z(t)}createEffect(t){const e=this.createLayer(t);return e.update({sketches:this.createFlatSketch(e.id+"_effectSketch")})}draw(t,e){const r=this.gl;return r.bindFramebuffer(r.FRAMEBUFFER,null),r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),at(r,t,e),this}compose(...t){for(const e of t)_t(this.gl,e);return this}display(t,e=0){return this.draw(this._staticSketch,{source:t.image(e)})}}function at(t,e,r,i){const{shade:n,form:s,_drawSettings:a,_uniforms:o}=e;if(!n||!s)throw Error("cannot draw, shader or geometry are not set");t.useProgram(n._program),function(t,e){for(const r in e._attribs){const i=t._attributeSetters[r];i&&i.setter(e._attribs[r])}}(n,s),r&&ut(n,r,i),a&&Y(t,a);for(let r=0;r<(o.length||1);r++)ot(t,e,o[r],i);a&&k(t,a)}function ot(t,e,r,i){r&&ut(e.shade,r,i),e.form._elements&&null!=e.form._elements.glType?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.form._elements.buffer),t.drawElements(e.form._drawType,e.form._itemCount,e.form._elements.glType,0)):t.drawArrays(e.form._drawType,0,e.form._itemCount)}function ut(t,e,r){for(const i in e){const n=t._uniformSetters[i];if(n){let t=e[i];"function"==typeof t&&(t=t()),"string"==typeof t&&r?n.setter(r[t]):n.setter(t)}}}function ft(t,e,r,i,n){i?(t.bindFramebuffer(t.FRAMEBUFFER,i.frameBuffer),t.viewport(0,0,i.width,i.height)):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)),e._data.drawSettings&&Y(t,e._data.drawSettings);for(const i of e.sketches)at(t,i,r,n);e._data.drawSettings&&k(t,e._data.drawSettings)}function _t(t,e){for(let r=0;r<e.layers.length;r++){const i=e.layers[r],n=i._uniforms.length||1;for(let s=0;s<n;s++){const n=e._targets[0],a=r+s===0&&e._textures.length?e._textures:e._targets[1]&&e._targets[1].textures;ft(t,i,i._uniforms[s],n,a),e._swapTargets()}}}r.d(e,"utils",function(){return lt}),r.d(e,"lib",function(){return ct}),r.d(e,"constants",function(){return Tt}),r.d(e,"Painter",function(){return st});const lt={geometry:{plane:a},stackgl:o,context:s},ct=n,Tt=i}])});