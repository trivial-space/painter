!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.tvsPainter=e():t.tvsPainter=e()}(window,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);var n={};r.r(n),r.d(n,"GEOMETRY_PROP_POSITION",function(){return s}),r.d(n,"GEOMETRY_PROP_NORMAL",function(){return l}),r.d(n,"GEOMETRY_PROP_UV",function(){return _}),r.d(n,"UNIFORM_SOURCE_TEXTURE",function(){return T}),r.d(n,"VARYING_UV_COORDS",function(){return E}),r.d(n,"GL_TYPE",function(){return c});var i={};r.r(i),r.d(i,"plane",function(){return h});var a={};r.r(a),r.d(a,"STACK_GL_GEOMETRY_PROP_POSITION",function(){return p}),r.d(a,"STACK_GL_GEOMETRY_PROP_NORMAL",function(){return g}),r.d(a,"STACK_GL_GEOMETRY_PROP_UV",function(){return y}),r.d(a,"STACK_GL_GEOMETRY_PROP_ELEMENTS",function(){return R}),r.d(a,"convertStackGLGeometry",function(){return S});var o={};r.r(o),r.d(o,"getContext",function(){return m}),r.d(o,"makeClear",function(){return N}),r.d(o,"setBlendFunc",function(){return F}),r.d(o,"resizeCanvas",function(){return v});var u={};r.r(u),r.d(u,"defaultTextureSettings",function(){return U}),r.d(u,"getDefaultLayerSettings",function(){return b}),r.d(u,"defaultForms",function(){return L}),r.d(u,"defaultShaders",function(){return M});var f={};r.r(f),r.d(f,"Painter",function(){return at});var s="position",l="normal",_="uv",T="source",E="coords",c={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FLOAT_MAT2X3:35685,FLOAT_MAT2X4:35686,FLOAT_MAT3X2:35687,FLOAT_MAT3X4:35688,FLOAT_MAT4X2:35689,FLOAT_MAT4X3:35690,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879,TEXTURE_2D_ARRAY:35866,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042};function h(t,e,r,n){var i,a,o=t/2,u=e/2,f=r||1,s=n||1,l=f+1,_=s+1,T=t/f,E=e/s,c=new Float32Array(l*_*3),h=new Float32Array(l*_*3),A=new Float32Array(l*_*2),d=0,p=0;for(i=0;i<_;i++){var g=i*E-u;for(a=0;a<l;a++){var y=a*T-o;c[d]=y,c[d+1]=-g,h[d+2]=1,A[p]=a/f,A[p+1]=1-i/s,d+=3,p+=2}}d=0;var R=new(c.length/3>65535?Uint32Array:Uint16Array)(f*s*6);for(i=0;i<s;i++)for(a=0;a<f;a++){var S=a+l*i,m=a+l*(i+1),N=a+1+l*(i+1),F=a+1+l*i;R[d]=S,R[d+1]=m,R[d+2]=F,R[d+3]=m,R[d+4]=N,R[d+5]=F,d+=6}return{attribs:{position:{buffer:c},normal:{buffer:h},uv:{buffer:A}},elements:{buffer:R},drawType:"TRIANGLES",itemCount:R.length}}function A(t,e){void 0===e&&(e=[]);for(var r=0,n=t;r<n.length;r++)for(var i=n[r],a=e.length,o=0;o<i.length;o++)e[o+a]=i[o];return e}var d,p="positions",g="normals",y="uvs",R="cells";function S(t){var e={drawType:"TRIANGLES",attribs:{},itemCount:0};for(var r in t){var n=t[r];if(r===R){var i=new(n.length>65535?Uint32Array:Uint16Array)(A(n));Object.assign(e,{elements:{buffer:i},itemCount:i.length})}else r===p?e.attribs[s]={buffer:new Float32Array(A(n))}:r===g?e.attribs[l]={buffer:new Float32Array(A(n))}:r===y?e.attribs[_]={buffer:new Float32Array(A(n))}:e.attribs[r]={buffer:new Float32Array(A(n))}}return e}function m(t){var e=t.getContext("webgl")||t.getContext("experimental-webgl");if(null==e)throw Error("Webgl context cannot be initialized");return e}function N(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return e.reduce(function(e,r){return e|t[r.toUpperCase()+"_BUFFER_BIT"]},0)}function F(t,e){t.blendFunc.apply(t,e.map(function(e){return t[e.toUpperCase()]}))}function v(t,e){void 0===e&&(e=1),e=Math.max(1,e);var r=t.clientWidth*e|0,n=t.clientHeight*e|0;return(t.width!==r||t.height!==n)&&(t.width=r,t.height=n,!0)}var U={wrap:"CLAMP_TO_EDGE",minFilter:"LINEAR",magFilter:"NEAREST"};function b(t){return{clearColor:[0,0,0,1],enable:[t.DEPTH_TEST],blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]}}var I,O,D,L={renderQuad:{attribs:(d={},d[s]={buffer:new Float32Array([-1,1,-1,-1,1,1,1,-1]),storeType:"STATIC"},d[_]={buffer:new Float32Array([0,1,0,0,1,1,1,0]),storeType:"STATIC"},d),drawType:"TRIANGLE_STRIP",itemCount:4}},M={basicEffect:{vert:"\n\t\t\tattribute vec2 "+s+";\n\t\t\tattribute vec2 "+_+";\n\t\t\tvarying vec2 "+E+";\n\t\t\tvoid main() {\n\t\t\t\t"+E+" = "+_+";\n\t\t\t\tgl_Position = vec4("+s+", 0.0, 1.0);\n\t\t\t}",frag:"precision mediump float;\n\t\t\tuniform sampler2D "+T+";\n\t\t\tvarying vec2 "+E+";\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D("+T+", "+E+");\n\t\t\t}"}};function P(t){return X[t].bindPoint}function C(t,e){return function(r){t.uniform1i(e,r)}}function B(t,e){return function(r){t.uniform1iv(e,r)}}function x(t,e){return function(r){t.uniform2iv(e,r)}}function w(t,e){return function(r){t.uniform3iv(e,r)}}function z(t,e){return function(r){t.uniform4iv(e,r)}}function G(t,e,r,n){var i=P(e);return function(e){t.uniform1i(n,r),t.activeTexture(t.TEXTURE0+r),t.bindTexture(i,e)}}function V(t,e,r,n,i){for(var a=P(e),o=new Int32Array(i),u=0;u<i;++u)o[u]=r+u;return function(e){for(var r in t.uniform1iv(n,o),e)t.activeTexture(t.TEXTURE0+o[r]),t.bindTexture(a,e[r])}}var X=((I={})[c.FLOAT]={Type:Float32Array,size:4,setter:function(t,e){return function(r){t.uniform1f(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1fv(e,r)}}},I[c.FLOAT_VEC2]={Type:Float32Array,size:8,setter:function(t,e){return function(r){t.uniform2fv(e,r)}}},I[c.FLOAT_VEC3]={Type:Float32Array,size:12,setter:function(t,e){return function(r){t.uniform3fv(e,r)}}},I[c.FLOAT_VEC4]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniform4fv(e,r)}}},I[c.INT]={Type:Int32Array,size:4,setter:C,arraySetter:B},I[c.INT_VEC2]={Type:Int32Array,size:8,setter:x},I[c.INT_VEC3]={Type:Int32Array,size:12,setter:w},I[c.INT_VEC4]={Type:Int32Array,size:16,setter:z},I[c.UNSIGNED_INT]={Type:Uint32Array,size:4,setter:function(t,e){return function(r){t.uniform1ui(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1uiv(e,r)}}},I[c.UNSIGNED_INT_VEC2]={Type:Uint32Array,size:8,setter:function(t,e){return function(r){t.uniform2uiv(e,r)}}},I[c.UNSIGNED_INT_VEC3]={Type:Uint32Array,size:12,setter:function(t,e){return function(r){t.uniform3uiv(e,r)}}},I[c.UNSIGNED_INT_VEC4]={Type:Uint32Array,size:16,setter:function(t,e){return function(r){t.uniform4uiv(e,r)}}},I[c.BOOL]={Type:Uint32Array,size:4,setter:C,arraySetter:B},I[c.BOOL_VEC2]={Type:Uint32Array,size:8,setter:x},I[c.BOOL_VEC3]={Type:Uint32Array,size:12,setter:w},I[c.BOOL_VEC4]={Type:Uint32Array,size:16,setter:z},I[c.FLOAT_MAT2]={Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniformMatrix2fv(e,!1,r)}}},I[c.FLOAT_MAT3]={Type:Float32Array,size:36,setter:function(t,e){return function(r){t.uniformMatrix3fv(e,!1,r)}}},I[c.FLOAT_MAT4]={Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4fv(e,!1,r)}}},I[c.FLOAT_MAT2X3]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix2x3fv(e,!1,r)}}},I[c.FLOAT_MAT2X4]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x4fv(e,!1,r)}}},I[c.FLOAT_MAT3X2]={Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix3x2fv(e,!1,r)}}},I[c.FLOAT_MAT3X4]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x4fv(e,!1,r)}}},I[c.FLOAT_MAT4X2]={Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix4x2fv(e,!1,r)}}},I[c.FLOAT_MAT4X3]={Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix4x3fv(e,!1,r)}}},I[c.SAMPLER_2D]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D},I[c.SAMPLER_CUBE]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_CUBE_MAP},I[c.SAMPLER_3D]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_3D},I[c.SAMPLER_2D_SHADOW]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D},I[c.SAMPLER_2D_ARRAY]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D_ARRAY},I[c.SAMPLER_2D_ARRAY_SHADOW]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D_ARRAY},I[c.SAMPLER_CUBE_SHADOW]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_CUBE_MAP},I[c.INT_SAMPLER_2D]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D},I[c.INT_SAMPLER_3D]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_3D},I[c.INT_SAMPLER_CUBE]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_CUBE_MAP},I[c.INT_SAMPLER_2D_ARRAY]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D_ARRAY},I[c.UNSIGNED_INT_SAMPLER_2D]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D},I[c.UNSIGNED_INT_SAMPLER_3D]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_3D},I[c.UNSIGNED_INT_SAMPLER_CUBE]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_CUBE_MAP},I[c.UNSIGNED_INT_SAMPLER_2D_ARRAY]={Type:null,size:0,setter:G,arraySetter:V,bindPoint:c.TEXTURE_2D_ARRAY},I);function Y(t,e,r){return function(n){t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.itemSize,c.FLOAT,n.normalize||!1,n.stride||0,n.offset||0)}}function H(t,e,r){return function(n){t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.itemSize,c.INT,n.stride||0,n.offset||0)}}function k(t,e,r){var n=r.size,i=r.count;return function(r){t.bindBuffer(t.ARRAY_BUFFER,r.buffer);for(var a=n,o=a/i,u=X[c.FLOAT].size*a,f=r.normalize||!1,s=r.offset||0,l=u/i,_=0;_<i;++_)t.enableVertexAttribArray(e+_),t.vertexAttribPointer(e+_,o,c.FLOAT,f,u,s+l*_)}}var W=((O={})[c.FLOAT]={size:4,setter:Y,itemSize:1},O[c.FLOAT_VEC2]={size:8,setter:Y,itemSize:2},O[c.FLOAT_VEC3]={size:12,setter:Y,itemSize:3},O[c.FLOAT_VEC4]={size:16,setter:Y,itemSize:4},O[c.INT]={size:4,setter:H,itemSize:1},O[c.INT_VEC2]={size:8,setter:H,itemSize:2},O[c.INT_VEC3]={size:12,setter:H,itemSize:3},O[c.INT_VEC4]={size:16,setter:H,itemSize:4},O[c.UNSIGNED_INT]={size:4,setter:H,itemSize:1},O[c.UNSIGNED_INT_VEC2]={size:8,setter:H,itemSize:2},O[c.UNSIGNED_INT_VEC3]={size:12,setter:H,itemSize:3},O[c.UNSIGNED_INT_VEC4]={size:16,setter:H,itemSize:4},O[c.BOOL]={size:4,setter:H,itemSize:1},O[c.BOOL_VEC2]={size:8,setter:H,itemSize:2},O[c.BOOL_VEC3]={size:12,setter:H,itemSize:3},O[c.BOOL_VEC4]={size:16,setter:H,itemSize:4},O[c.FLOAT_MAT2]={size:4,setter:k,count:2},O[c.FLOAT_MAT3]={size:9,setter:k,count:3},O[c.FLOAT_MAT4]={size:16,setter:k,count:4},O);(D={})[c.BYTE]=Int8Array,D[c.UNSIGNED_BYTE]=Uint8Array,D[c.SHORT]=Int16Array,D[c.UNSIGNED_SHORT]=Uint16Array,D[c.INT]=Int32Array,D[c.UNSIGNED_INT]=Uint32Array,D[c.FLOAT]=Float32Array,D[c.UNSIGNED_SHORT_4_4_4_4]=Uint16Array,D[c.UNSIGNED_SHORT_5_5_5_1]=Uint16Array,D[c.UNSIGNED_SHORT_5_6_5]=Uint16Array,D[c.HALF_FLOAT]=Uint16Array,D[c.UNSIGNED_INT_2_10_10_10_REV]=Uint32Array,D[c.UNSIGNED_INT_10F_11F_11F_REV]=Uint32Array,D[c.UNSIGNED_INT_5_9_9_9_REV]=Uint32Array,D[c.FLOAT_32_UNSIGNED_INT_24_8_REV]=Uint32Array,D[c.UNSIGNED_INT_24_8]=Uint32Array;function j(t,e,r){if(void 0===e&&(e={}),void 0===r&&(r={}),null!=e.flipY&&e.flipY!==r.flipY&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY),e.wrap&&e.wrap!==r.wrap||e.wrapS&&e.wrapS!==r.wrapS||e.wrapT&&e.wrapT!==r.wrapT){var n=void 0,i=void 0;e.wrap?n=i=e.wrap:(i=e.wrapT||"CLAMP_TO_EDGE",n=e.wrapS||"CLAMP_TO_EDGE"),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t[n]),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t[i])}e.magFilter&&e.magFilter!==r.magFilter&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t[e.magFilter]),e.minFilter&&e.minFilter!==r.minFilter&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t[e.minFilter])}function K(t,e,r,n){if(null!=e.width&&null!=e.height){null==e.frameBuffer&&(e.frameBuffer=t.createFramebuffer()),e.textures||(e.textures=[]),t.bindFramebuffer(t.FRAMEBUFFER,e.frameBuffer),e.textureConfig.type===t.FLOAT&&t.getExtension("OES_texture_float");var i=e.textureConfig.count;if(i>1){for(var a=t.getExtension("WEBGL_draw_buffers")||{drawBuffersWEBGL:function(){}},o=[],u=0;u<i;u++)o.push(a["COLOR_ATTACHMENT"+u+"_WEBGL"]);a.drawBuffersWEBGL(o);for(u=0;u<i;u++){null==e.textures[u]&&(e.textures[u]=t.createTexture());var f=e.textures[u];t.bindTexture(t.TEXTURE_2D,f),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.width,e.height,0,t.RGBA,e.textureConfig.type,null),j(t,r,n),t.framebufferTexture2D(t.FRAMEBUFFER,o[u],t.TEXTURE_2D,f,0)}}else{null==e.textures[0]&&(e.textures[0]=t.createTexture());f=e.textures[0];t.bindTexture(t.TEXTURE_2D,f),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.width,e.height,0,t.RGBA,e.textureConfig.type,null),j(t,r,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,f,0)}null==e.depthBuffer&&(e.depthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e.depthBuffer);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);s!==t.FRAMEBUFFER_COMPLETE&&console.error("framebuffer error",s,r),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}}function Q(t,e){t.deleteFramebuffer(e.frameBuffer),t.deleteRenderbuffer(e.depthBuffer);for(var r=0,n=e.textures;r<n.length;r++){var i=n[r];t.deleteTexture(i)}}function q(t,e){if(e.enable)for(var r=0,n=e.enable;r<n.length;r++){var i=n[r];t.enable(i)}if(e.disable)for(var a=0,o=e.disable;a<o.length;a++){i=o[a];t.disable(i)}e.blendFunc&&t.blendFunc.apply(t,e.blendFunc),null!=e.depthFunc&&t.depthFunc(e.depthFunc),null!=e.cullFace&&t.cullFace(e.cullFace),null!=e.frontFace&&t.frontFace(e.frontFace),null!=e.lineWidth&&t.lineWidth(e.lineWidth),e.colorMask&&t.colorMask.apply(t,e.colorMask),null!=e.depthMask&&t.depthMask(e.depthMask),e.clearColor&&t.clearColor.apply(t,e.clearColor),null!=e.clearDepth&&t.clearDepth(e.clearDepth),null!=e.clearBits&&t.clear(e.clearBits)}function J(t,e){if(e.enable)for(var r=0,n=e.enable;r<n.length;r++){var i=n[r];t.disable(i)}if(e.disable)for(var a=0,o=e.disable;a<o.length;a++){i=o[a];t.enable(i)}}var Z=function(){function t(t){this.gl=t}return t.prototype.update=function(t){var e=this.gl;for(var r in t.drawType&&(this.drawType=e[t.drawType]),t.itemCount&&(this.itemCount=t.itemCount),this.attribs=this.attribs||{},t.attribs){var n=t.attribs[r];null==this.attribs[r]&&(this.attribs[r]={buffer:e.createBuffer()}),e.bindBuffer(e.ARRAY_BUFFER,this.attribs[r].buffer),e.bufferData(e.ARRAY_BUFFER,n.buffer,e[(n.storeType||"STATIC")+"_DRAW"])}if(t.elements){var i=t.elements.buffer;null==this.elements&&(this.elements={buffer:e.createBuffer(),glType:null}),this.elements.glType=function(t){if(t instanceof Int8Array)return c.BYTE;if(t instanceof Uint8Array)return c.UNSIGNED_BYTE;if(t instanceof Uint8ClampedArray)return c.UNSIGNED_BYTE;if(t instanceof Int16Array)return c.SHORT;if(t instanceof Uint16Array)return c.UNSIGNED_SHORT;if(t instanceof Int32Array)return c.INT;if(t instanceof Uint32Array)return c.UNSIGNED_INT;if(t instanceof Float32Array)return c.FLOAT;throw"unsupported typed array type"}(i),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.elements.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e[(t.elements.storeType||"STATIC")+"_DRAW"])}return this},t.prototype.destroy=function(){for(var t in this.attribs)this.gl.deleteBuffer(this.attribs[t].buffer);this.elements&&this.gl.deleteBuffer(this.elements.buffer)},t}(),$=function(){function t(t){this.gl=t,this.program=t.createProgram(),this.frag=t.createShader(t.FRAGMENT_SHADER),this.vert=t.createShader(t.VERTEX_SHADER),t.attachShader(this.program,this.vert),t.attachShader(this.program,this.frag)}return t.prototype.update=function(t){var e=this.gl,r=t.frag&&t.frag.trim()||this.fragSource,n=t.vert&&t.vert.trim()||this.vertSource;if(!r||!n)return this;if(r.indexOf("GL_EXT_draw_buffers")>=0&&e.getExtension("WEBGL_draw_buffers"),e.shaderSource(this.vert,n),e.shaderSource(this.frag,r),e.compileShader(this.vert),e.compileShader(this.frag),e.getShaderParameter(this.vert,e.COMPILE_STATUS)||console.error("Error Compiling Vertex Shader!\n",e.getShaderInfoLog(this.vert),tt(n)),e.getShaderParameter(this.frag,e.COMPILE_STATUS)||console.error("Error Compiling Fragment Shader!\n",e.getShaderInfoLog(this.frag),tt(r)),e.linkProgram(this.program),!e.getProgramParameter(this.program,e.LINK_STATUS)){var i=e.getProgramInfoLog(this.program);console.error("Error in program linking:",i)}return this.uniformSetters=function(t,e){var r=0;function n(e,n){var i=t.getUniformLocation(e,n.name),a=n.size>1&&"[0]"===n.name.substr(-3),o=n.type,u=X[o];if(!u)throw"unknown type: 0x"+o.toString(16);if(null!=i){var f;if(null===u.Type){var s=r;r+=n.size,f=a?u.arraySetter(t,o,s,i,n.size):u.setter(t,o,s,i)}else f=u.arraySetter&&a?u.arraySetter(t,i):u.setter(t,i);return{setter:f,location:i}}}for(var i={},a=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),o=0;o<a;++o){var u=t.getActiveUniform(e,o);if(!u)break;var f=u.name;if("[0]"===f.substr(-3)&&(f=f.substr(0,f.length-3)),e){var s=n(e,u);s&&(i[f]=s)}}return i}(e,this.program),this.attributeSetters=function(t,e){for(var r={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),i=0;i<n;i++){var a=t.getActiveAttrib(e,i);if(!a)break;var o=t.getAttribLocation(e,a.name),u=W[a.type],f=u.setter(t,o,u);r[a.name]={setter:f,location:o}}return r}(e,this.program),this.fragSource=r,this.vertSource=n,this},t.prototype.destroy=function(){this.gl.deleteProgram(this.program),this.gl.deleteShader(this.frag),this.gl.deleteShader(this.vert)},t}();function tt(t){return t.trim().split("\n").map(function(t,e){return e+1+": "+t}).join("\n")}var et=function(){function t(){}return t.prototype.update=function(t){return t.drawSettings&&(this.drawSettings=t.drawSettings),t.form&&(this.form=t.form),t.shade&&(this.shade=t.shade),t.uniforms&&(this.uniforms=t.uniforms),this},t.prototype.destroy=function(){this.form&&this.form.destroy(),this.shade&&this.shade.destroy()},t}(),rt=function(){function t(t){this.data={},this.gl=t,this._texture=t.createTexture()}return t.prototype.texture=function(){return this._texture},t.prototype.update=function(t){return this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture()),j(this.gl,t,this.data),t.asset&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.asset),t.minFilter&&t.minFilter.indexOf("MIPMAP")>0&&this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.bindTexture(this.gl.TEXTURE_2D,null),Object.assign(this.data,t),this},t.prototype.destroy=function(){this.gl.deleteTexture(this.texture())},t}(),nt=function(){function t(t){this.gl=t,this.data={}}return t.prototype.texture=function(t){return void 0===t&&(t=0),this.targets&&this.targets[0].textures[t]||null},t.prototype.update=function(t){var e=this;if(t.buffered&&!this.targets?(this.targets=function(t,e,r){void 0===r&&(r=[]);for(var n=0;n<e;n++)r[n]=t(n);return r}(function(){return{width:t.width||e.gl.canvas.width,height:t.height||e.gl.canvas.height,frameBuffer:null,textures:[],depthBuffer:null,textureConfig:{type:t.textureConfig&&t.textureConfig.type||e.gl.UNSIGNED_BYTE,count:t.textureConfig&&t.textureConfig.count||1}}},2),this.targets.forEach(function(r){return K(e.gl,r,t,e.data)})):this.targets&&t.width&&t.height&&this.targets.forEach(function(r){r.width=t.width,r.height=t.height,K(e.gl,r,t,e.data)}),t.sketches&&(this.sketches=t.sketches),t.frag){var r=this.sketches&&this.sketches[0];r&&r.shade.update({frag:t.frag})}return t.uniforms&&(this.uniforms=t.uniforms),Object.assign(this.data,t),this},t.prototype.destroy=function(){var t=this;if(this.sketches)for(var e=0,r=this.sketches;e<r.length;e++){r[e].destroy()}this.targets&&(this.targets.forEach(function(e){return Q(t.gl,e)}),this.targets=void 0)},t}(),it=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},at=function(){function t(t){this.gl=t,this.targets=[{},{}],this.resize(1,!0),this.renderQuad=this.createForm().update(L.renderQuad),this.result=this.createFlatSketch()}return t.prototype.resize=function(t,e){var r=this;void 0===t&&(t=1),void 0===e&&(e=!1);var n=this.gl.canvas;return(v(n,t)||e)&&this.targets.forEach(function(t){t.width=n.width,t.height=n.height,t.textureConfig={count:1,type:r.gl.UNSIGNED_BYTE},K(r.gl,t,U)}),this},t.prototype.destroy=function(){this.result.destroy();for(var t=0,e=this.targets;t<e.length;t++){var r=e[t];Q(this.gl,r)}},t.prototype.updateDrawSettings=function(t){return q(this.gl,it({},b(this.gl),t)),this},t.prototype.createForm=function(){return new Z(this.gl)},t.prototype.createShade=function(){return new $(this.gl)},t.prototype.createSketch=function(){return new et},t.prototype.createFlatSketch=function(){return this.createSketch().update({form:this.renderQuad,shade:this.createShade().update(M.basicEffect)})},t.prototype.createStaticLayer=function(){return new rt(this.gl)},t.prototype.createDrawingLayer=function(){return new nt(this.gl)},t.prototype.createEffectLayer=function(){return this.createDrawingLayer().update({sketches:[this.createFlatSketch()]})},t.prototype.draw=function(t,e){return ot(this.gl,t,null,e),this},t.prototype.compose=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return function(t,e,r,n){for(var i=e.length-1,a=0;a<e.length;a++){var o=e[a];if(Array.isArray(o.uniforms)){var u=i+o.uniforms.length-1;o.looping=!1;for(var f=0;f<o.uniforms.length;f++){var s=a+f===u;st(t,o,r,o.uniforms[f],n,s)}}else{var s=a===i;st(t,o,r,o.uniforms,n,s)}}}(this.gl,t,this.targets,this.result),this},t}();function ot(t,e,r,n){var i=e.shade,a=e.form,o=e.drawSettings,u=e.uniforms;if(!i||!a)throw Error("cannot draw, shader or geometry are not set");if(t.useProgram(i.program),function(t,e){for(var r in e.attribs){var n=t.attributeSetters[r];n&&n.setter(e.attribs[r])}}(i,a),n&&ft(i,n,r),o&&q(t,o),Array.isArray(u))for(var f=0,s=u;f<s.length;f++){ut(t,e,r,s[f])}else ut(t,e,r,u);o&&J(t,o)}function ut(t,e,r,n){n&&ft(e.shade,n,r),e.form.elements&&null!=e.form.elements.glType?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.form.elements.buffer),t.drawElements(e.form.drawType,e.form.itemCount,e.form.elements.glType,0)):t.drawArrays(e.form.drawType,0,e.form.itemCount)}function ft(t,e,r){for(var n in e){var i=t.uniformSetters[n];if(i){var a=e[n];"function"==typeof a&&(a=a()),null===a||"string"==typeof a?i.setter(r):i.setter(a)}}}function st(t,e,r,n,i,a){var o=r[0],u=r[1];if(a?(t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)):e.targets?(t.bindFramebuffer(t.FRAMEBUFFER,e.targets[1].frameBuffer),t.viewport(0,0,e.targets[1].width,e.targets[1].height)):(t.bindFramebuffer(t.FRAMEBUFFER,u.frameBuffer),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight)),e.data.drawSettings&&q(t,e.data.drawSettings),e.sketches)for(var f=0,s=e.sketches;f<s.length;f++){ot(t,s[f],e.looping&&e.texture()||o.textures[0],n)}else ot(t,i,null,{source:e.texture()});if(e.data.drawSettings&&J(t,e.data.drawSettings),!a)if(e.targets){var l=e.targets[0];e.targets[0]=e.targets[1],e.targets[1]=l,e.looping=!0}else r[0]=u,r[1]=o}r.d(e,"utils",function(){return lt}),r.d(e,"lib",function(){return _t}),r.d(e,"constants",function(){return Tt}),r.d(e,"painter",function(){return Et});var lt={geometry:{plane:i},stackgl:a,context:o},_t=u,Tt=n,Et=f;e.default=Et}])});