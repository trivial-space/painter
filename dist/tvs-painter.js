!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.tvsPainter=e():t.tvsPainter=e()}(window,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);var n={};r.r(n),r.d(n,"GEOMETRY_PROP_POSITION",function(){return u}),r.d(n,"GEOMETRY_PROP_NORMAL",function(){return f}),r.d(n,"GEOMETRY_PROP_UV",function(){return l}),r.d(n,"UNIFORM_SOURCE_TEXTURE",function(){return c}),r.d(n,"VARYING_UV_COORDS",function(){return T}),r.d(n,"GL_TYPE",function(){return E});var i={};r.r(i),r.d(i,"defaultTextureSettings",function(){return _}),r.d(i,"getDefaultLayerSettings",function(){return h}),r.d(i,"defaultForms",function(){return A}),r.d(i,"defaultShaders",function(){return d});var s={};r.r(s),r.d(s,"getContext",function(){return g}),r.d(s,"makeClear",function(){return S}),r.d(s,"setBlendFunc",function(){return R}),r.d(s,"resizeCanvas",function(){return m});var a={};r.r(a),r.d(a,"plane",function(){return y});var o={};r.r(o),r.d(o,"STACK_GL_GEOMETRY_PROP_POSITION",function(){return F}),r.d(o,"STACK_GL_GEOMETRY_PROP_NORMAL",function(){return b}),r.d(o,"STACK_GL_GEOMETRY_PROP_UV",function(){return U}),r.d(o,"STACK_GL_GEOMETRY_PROP_ELEMENTS",function(){return N}),r.d(o,"convertStackGLGeometry",function(){return I});const u="position",f="normal",l="uv",c="source",T="coords",E={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FLOAT_MAT2X3:35685,FLOAT_MAT2X4:35686,FLOAT_MAT3X2:35687,FLOAT_MAT3X4:35688,FLOAT_MAT4X2:35689,FLOAT_MAT4X3:35690,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879,TEXTURE_2D_ARRAY:35866,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042},_={wrap:"CLAMP_TO_EDGE",minFilter:"LINEAR",magFilter:"NEAREST"};function h(t){return{clearColor:[0,0,0,1],enable:[t.DEPTH_TEST],blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]}}const A={renderQuad:{attribs:{[u]:{buffer:new Float32Array([-1,1,-1,-1,1,1,1,-1]),storeType:"STATIC"},[l]:{buffer:new Float32Array([0,1,0,0,1,1,1,0]),storeType:"STATIC"}},drawType:"TRIANGLE_STRIP",itemCount:4}},d={basicEffect:{vert:`\nattribute vec2 ${u};\nattribute vec2 ${l};\nvarying vec2 ${T};\nvoid main() {\n\t${T} = ${l};\n\tgl_Position = vec4(${u}, 0.0, 1.0);\n}`,frag:`precision mediump float;\nuniform sampler2D ${c};\nvarying vec2 ${T};\nvoid main() {\n\tgl_FragColor = texture2D(${c}, ${T});\n}`}};function g(t,e){const r=t.getContext("webgl",e)||t.getContext("experimental-webgl",e);if(null==r)throw Error("Webgl context cannot be initialized");return r}function S(t,...e){return e.reduce((e,r)=>e|t[r.toUpperCase()+"_BUFFER_BIT"],0)}function R(t,e){t.blendFunc.apply(t,e.map(e=>t[e.toUpperCase()]))}function m(t,e=1){const r=t.clientWidth*e|0,n=t.clientHeight*e|0;return(t.width!==r||t.height!==n)&&(t.width=r,t.height=n,!0)}function y(t,e,r,n){const i=t/2,s=e/2,a=r||1,o=n||1,u=a+1,f=o+1,l=t/a,c=e/o,T=new Float32Array(u*f*3),E=new Float32Array(u*f*3),_=new Float32Array(u*f*2);let h,A,d=0,g=0;for(h=0;h<f;h++){const t=h*c-s;for(A=0;A<u;A++){const e=A*l-i;T[d]=e,T[d+1]=-t,E[d+2]=1,_[g]=A/a,_[g+1]=1-h/o,d+=3,g+=2}}d=0;const S=new(T.length/3>65535?Uint32Array:Uint16Array)(a*o*6);for(h=0;h<o;h++)for(A=0;A<a;A++){const t=A+u*h,e=A+u*(h+1),r=A+1+u*(h+1),n=A+1+u*h;S[d]=t,S[d+1]=e,S[d+2]=n,S[d+3]=e,S[d+4]=r,S[d+5]=n,d+=6}return{attribs:{position:{buffer:T},normal:{buffer:E},uv:{buffer:_}},elements:{buffer:S},drawType:"TRIANGLES",itemCount:S.length}}function p(t,e=[]){for(const r of t){const t=e.length;for(let n=0;n<r.length;n++)e[n+t]=r[n]}return e}const F="positions",b="normals",U="uvs",N="cells";function I(t){const e={drawType:"TRIANGLES",attribs:{},itemCount:0};for(const r in t){const n=t[r];if(r===N){const t=new(n.length>65535?Uint32Array:Uint16Array)(p(n));Object.assign(e,{elements:{buffer:t},itemCount:t.length})}else r===F?e.attribs[u]={buffer:new Float32Array(p(n))}:r===b?e.attribs[f]={buffer:new Float32Array(p(n))}:r===U?e.attribs[l]={buffer:new Float32Array(p(n))}:e.attribs[r]={buffer:new Float32Array(p(n))}}return e}function L(t){return x[t].bindPoint}function O(t,e){return function(r){t.uniform1i(e,r)}}function D(t,e){return function(r){t.uniform1iv(e,r)}}function M(t,e){return function(r){t.uniform2iv(e,r)}}function P(t,e){return function(r){t.uniform3iv(e,r)}}function C(t,e){return function(r){t.uniform4iv(e,r)}}function w(t,e,r,n){const i=L(e);return function(e){t.uniform1i(n,r),t.activeTexture(t.TEXTURE0+r),t.bindTexture(i,e)}}function B(t,e,r,n,i){const s=L(e),a=new Int32Array(i);for(let t=0;t<i;++t)a[t]=r+t;return function(e){t.uniform1iv(n,a);for(const r in e)t.activeTexture(t.TEXTURE0+a[r]),t.bindTexture(s,e[r])}}const x={[E.FLOAT]:{Type:Float32Array,size:4,setter:function(t,e){return function(r){t.uniform1f(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1fv(e,r)}}},[E.FLOAT_VEC2]:{Type:Float32Array,size:8,setter:function(t,e){return function(r){t.uniform2fv(e,r)}}},[E.FLOAT_VEC3]:{Type:Float32Array,size:12,setter:function(t,e){return function(r){t.uniform3fv(e,r)}}},[E.FLOAT_VEC4]:{Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniform4fv(e,r)}}},[E.INT]:{Type:Int32Array,size:4,setter:O,arraySetter:D},[E.INT_VEC2]:{Type:Int32Array,size:8,setter:M},[E.INT_VEC3]:{Type:Int32Array,size:12,setter:P},[E.INT_VEC4]:{Type:Int32Array,size:16,setter:C},[E.UNSIGNED_INT]:{Type:Uint32Array,size:4,setter:function(t,e){return function(r){t.uniform1ui(e,r)}},arraySetter:function(t,e){return function(r){t.uniform1uiv(e,r)}}},[E.UNSIGNED_INT_VEC2]:{Type:Uint32Array,size:8,setter:function(t,e){return function(r){t.uniform2uiv(e,r)}}},[E.UNSIGNED_INT_VEC3]:{Type:Uint32Array,size:12,setter:function(t,e){return function(r){t.uniform3uiv(e,r)}}},[E.UNSIGNED_INT_VEC4]:{Type:Uint32Array,size:16,setter:function(t,e){return function(r){t.uniform4uiv(e,r)}}},[E.BOOL]:{Type:Uint32Array,size:4,setter:O,arraySetter:D},[E.BOOL_VEC2]:{Type:Uint32Array,size:8,setter:M},[E.BOOL_VEC3]:{Type:Uint32Array,size:12,setter:P},[E.BOOL_VEC4]:{Type:Uint32Array,size:16,setter:C},[E.FLOAT_MAT2]:{Type:Float32Array,size:16,setter:function(t,e){return function(r){t.uniformMatrix2fv(e,!1,r)}}},[E.FLOAT_MAT3]:{Type:Float32Array,size:36,setter:function(t,e){return function(r){t.uniformMatrix3fv(e,!1,r)}}},[E.FLOAT_MAT4]:{Type:Float32Array,size:64,setter:function(t,e){return function(r){t.uniformMatrix4fv(e,!1,r)}}},[E.FLOAT_MAT2X3]:{Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix2x3fv(e,!1,r)}}},[E.FLOAT_MAT2X4]:{Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix2x4fv(e,!1,r)}}},[E.FLOAT_MAT3X2]:{Type:Float32Array,size:24,setter:function(t,e){return function(r){t.uniformMatrix3x2fv(e,!1,r)}}},[E.FLOAT_MAT3X4]:{Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix3x4fv(e,!1,r)}}},[E.FLOAT_MAT4X2]:{Type:Float32Array,size:32,setter:function(t,e){return function(r){t.uniformMatrix4x2fv(e,!1,r)}}},[E.FLOAT_MAT4X3]:{Type:Float32Array,size:48,setter:function(t,e){return function(r){t.uniformMatrix4x3fv(e,!1,r)}}},[E.SAMPLER_2D]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D},[E.SAMPLER_CUBE]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_CUBE_MAP},[E.SAMPLER_3D]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_3D},[E.SAMPLER_2D_SHADOW]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D},[E.SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D_ARRAY},[E.SAMPLER_2D_ARRAY_SHADOW]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D_ARRAY},[E.SAMPLER_CUBE_SHADOW]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_CUBE_MAP},[E.INT_SAMPLER_2D]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D},[E.INT_SAMPLER_3D]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_3D},[E.INT_SAMPLER_CUBE]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_CUBE_MAP},[E.INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D_ARRAY},[E.UNSIGNED_INT_SAMPLER_2D]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D},[E.UNSIGNED_INT_SAMPLER_3D]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_3D},[E.UNSIGNED_INT_SAMPLER_CUBE]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_CUBE_MAP},[E.UNSIGNED_INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:w,arraySetter:B,bindPoint:E.TEXTURE_2D_ARRAY}};function z(t,e,r){return function(n){t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,r.itemSize,E.FLOAT,n.normalize||!1,n.stride||0,n.offset||0)}}function v(t,e,r){return function(n){t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.enableVertexAttribArray(e),t.vertexAttribIPointer(e,r.itemSize,E.INT,n.stride||0,n.offset||0)}}function G(t,e,r){const n=r.size,i=r.count;return function(r){t.bindBuffer(t.ARRAY_BUFFER,r.buffer);const s=n,a=s/i,o=x[E.FLOAT].size*s,u=r.normalize||!1,f=r.offset||0,l=o/i;for(let r=0;r<i;++r)t.enableVertexAttribArray(e+r),t.vertexAttribPointer(e+r,a,E.FLOAT,u,o,f+l*r)}}const X={[E.FLOAT]:{size:4,setter:z,itemSize:1},[E.FLOAT_VEC2]:{size:8,setter:z,itemSize:2},[E.FLOAT_VEC3]:{size:12,setter:z,itemSize:3},[E.FLOAT_VEC4]:{size:16,setter:z,itemSize:4},[E.INT]:{size:4,setter:v,itemSize:1},[E.INT_VEC2]:{size:8,setter:v,itemSize:2},[E.INT_VEC3]:{size:12,setter:v,itemSize:3},[E.INT_VEC4]:{size:16,setter:v,itemSize:4},[E.UNSIGNED_INT]:{size:4,setter:v,itemSize:1},[E.UNSIGNED_INT_VEC2]:{size:8,setter:v,itemSize:2},[E.UNSIGNED_INT_VEC3]:{size:12,setter:v,itemSize:3},[E.UNSIGNED_INT_VEC4]:{size:16,setter:v,itemSize:4},[E.BOOL]:{size:4,setter:v,itemSize:1},[E.BOOL_VEC2]:{size:8,setter:v,itemSize:2},[E.BOOL_VEC3]:{size:12,setter:v,itemSize:3},[E.BOOL_VEC4]:{size:16,setter:v,itemSize:4},[E.FLOAT_MAT2]:{size:4,setter:G,count:2},[E.FLOAT_MAT3]:{size:9,setter:G,count:3},[E.FLOAT_MAT4]:{size:16,setter:G,count:4}};Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Uint16Array,Uint16Array,Uint16Array,Uint16Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array,Uint32Array;function V(t,e={},r={}){if(null!=e.flipY&&e.flipY!==r.flipY&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY),e.wrap&&e.wrap!==r.wrap||e.wrapS&&e.wrapS!==r.wrapS||e.wrapT&&e.wrapT!==r.wrapT){let r,n;e.wrap?r=n=e.wrap:(n=e.wrapT||"CLAMP_TO_EDGE",r=e.wrapS||"CLAMP_TO_EDGE"),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t[r]),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t[n])}e.magFilter&&e.magFilter!==r.magFilter&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t[e.magFilter]),e.minFilter&&e.minFilter!==r.minFilter&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t[e.minFilter])}function Y(t,e,r,n){if(null==e.width||null==e.height)return;null==e.frameBuffer&&(e.frameBuffer=t.createFramebuffer()),e.textures||(e.textures=[]),t.bindFramebuffer(t.FRAMEBUFFER,e.frameBuffer),e.textureConfig.type===t.FLOAT&&t.getExtension("OES_texture_float");const i=e.textureConfig.count;if(i>1){const s=t.getExtension("WEBGL_draw_buffers")||{drawBuffersWEBGL(){}},a=[];for(let t=0;t<i;t++)a.push(s[`COLOR_ATTACHMENT${t}_WEBGL`]);s.drawBuffersWEBGL(a);for(let s=0;s<i;s++){null==e.textures[s]&&(e.textures[s]=t.createTexture());const i=e.textures[s];t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.width,e.height,0,t.RGBA,e.textureConfig.type,null),V(t,r,n),t.framebufferTexture2D(t.FRAMEBUFFER,a[s],t.TEXTURE_2D,i,0)}}else{null==e.textures[0]&&(e.textures[0]=t.createTexture());const i=e.textures[0];t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.width,e.height,0,t.RGBA,e.textureConfig.type,null),V(t,r,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0)}null==e.depthBuffer&&(e.depthBuffer=t.createRenderbuffer()),t.bindRenderbuffer(t.RENDERBUFFER,e.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e.depthBuffer);const s=t.checkFramebufferStatus(t.FRAMEBUFFER);s!==t.FRAMEBUFFER_COMPLETE&&console.error("framebuffer error",s,r),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindTexture(t.TEXTURE_2D,null),t.bindRenderbuffer(t.RENDERBUFFER,null)}function k(t,e){t.deleteFramebuffer(e.frameBuffer),t.deleteRenderbuffer(e.depthBuffer);for(const r of e.textures)t.deleteTexture(r)}function H(t,e){if(e.enable)for(const r of e.enable)t.enable(r);if(e.disable)for(const r of e.disable)t.disable(r);e.blendFunc&&t.blendFunc.apply(t,e.blendFunc),null!=e.depthFunc&&t.depthFunc(e.depthFunc),null!=e.cullFace&&t.cullFace(e.cullFace),null!=e.frontFace&&t.frontFace(e.frontFace),null!=e.lineWidth&&t.lineWidth(e.lineWidth),e.colorMask&&t.colorMask.apply(t,e.colorMask),null!=e.depthMask&&t.depthMask(e.depthMask),e.clearColor&&t.clearColor.apply(t,e.clearColor),null!=e.clearDepth&&t.clearDepth(e.clearDepth),null!=e.clearBits&&t.clear(e.clearBits)}function W(t,e){if(e.enable)for(const r of e.enable)t.disable(r);if(e.disable)for(const r of e.disable)t.enable(r)}let j=1;class ${constructor(t,e="Form"+j++){this.gl=t,this.id=e}update(t){const e=this.gl;t.drawType&&(this.drawType=e[t.drawType]),t.itemCount&&(this.itemCount=t.itemCount),this.attribs=this.attribs||{};for(const r in t.attribs){const n=t.attribs[r];null==this.attribs[r]&&(this.attribs[r]={buffer:e.createBuffer()}),e.bindBuffer(e.ARRAY_BUFFER,this.attribs[r].buffer),e.bufferData(e.ARRAY_BUFFER,n.buffer,e[(n.storeType||"STATIC")+"_DRAW"])}if(t.elements){const r=t.elements.buffer;null==this.elements&&(this.elements={buffer:e.createBuffer(),glType:null}),this.elements.glType=function(t){if(t instanceof Int8Array)return E.BYTE;if(t instanceof Uint8Array)return E.UNSIGNED_BYTE;if(t instanceof Uint8ClampedArray)return E.UNSIGNED_BYTE;if(t instanceof Int16Array)return E.SHORT;if(t instanceof Uint16Array)return E.UNSIGNED_SHORT;if(t instanceof Int32Array)return E.INT;if(t instanceof Uint32Array)return E.UNSIGNED_INT;if(t instanceof Float32Array)return E.FLOAT;throw"unsupported typed array type"}(r),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.elements.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e[(t.elements.storeType||"STATIC")+"_DRAW"])}return this}destroy(){for(const t in this.attribs)this.gl.deleteBuffer(this.attribs[t].buffer);this.elements&&this.gl.deleteBuffer(this.elements.buffer)}}let K=1;class Q{constructor(t,e="StaticLayer"+K++){this.gl=t,this.id=e,this.data={},this._texture=t.createTexture()}texture(){return this._texture}update(t){return this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture()),t.asset&&(t.wrap||t.wrapS||t.wrapT||(t.wrap=_.wrap),t.minFilter||(t.minFilter=_.minFilter),t.magFilter||(t.magFilter=_.magFilter)),V(this.gl,t,this.data),t.asset&&this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t.asset),t.minFilter&&t.minFilter.indexOf("MIPMAP")>0&&this.gl.generateMipmap(this.gl.TEXTURE_2D),this.gl.bindTexture(this.gl.TEXTURE_2D,null),Object.assign(this.data,t),this}destroy(){this.gl.deleteTexture(this.texture())}}let q=1;class J{constructor(t,e="DrawingLayer"+q++){this.gl=t,this.id=e,this.data={}}texture(t=0){return this.targets&&this.targets[0].textures[t]||null}update(t){if(t.buffered&&!this.targets?(this.targets=function(t,e,r=[]){for(let n=0;n<e;n++)r[n]=t(n);return r}(e=>({id:this.id+"_target"+(e+1),width:t.width||this.gl.canvas.width,height:t.height||this.gl.canvas.height,frameBuffer:null,textures:[],depthBuffer:null,textureConfig:{type:t.textureConfig&&t.textureConfig.type||this.gl.UNSIGNED_BYTE,count:t.textureConfig&&t.textureConfig.count||1}}),t.doubleBuffered?2:1),t.wrap||t.wrapS||t.wrapT||(t.wrap=_.wrap),t.minFilter||(t.minFilter=_.minFilter),t.magFilter||(t.magFilter=_.magFilter),this.targets.forEach(e=>Y(this.gl,e,t,this.data))):this.targets&&t.width&&t.height&&(t.width!==this.data.width||t.height!==this.data.height)&&this.targets.forEach(e=>{e.width=t.width,e.height=t.height,Y(this.gl,e,t,this.data)}),t.sketches&&(this.sketches=t.sketches),t.frag){const e=this.sketches&&this.sketches[0];e&&e.shade.update({frag:t.frag})}return t.uniforms&&(this.uniforms=t.uniforms),Object.assign(this.data,t),this}destroy(){if(this.sketches)for(const t of this.sketches)t.destroy();this.targets&&(this.targets.forEach(t=>k(this.gl,t)),this.targets=void 0)}}let Z=1;class tt{constructor(t,e="Shade"+Z++){this.gl=t,this.id=e}update(t){const e=this.gl,r=t.frag&&t.frag.trim()||this.fragSource,n=t.vert&&t.vert.trim()||this.vertSource;if(!r||!n||r===this.fragSource&&n===this.vertSource)return this;this.destroy(),r.indexOf("GL_EXT_draw_buffers")>=0&&e.getExtension("WEBGL_draw_buffers");const i=e.createProgram(),s=e.createShader(e.FRAGMENT_SHADER),a=e.createShader(e.VERTEX_SHADER);if(this.program=i,this.frag=s,this.vert=a,i&&a&&s){if(e.attachShader(i,a),e.attachShader(i,s),e.shaderSource(a,n),e.shaderSource(s,r),e.compileShader(a),e.compileShader(s),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("Error Compiling Vertex Shader!\n",e.getShaderInfoLog(a),et(n)),e.getShaderParameter(s,e.COMPILE_STATUS)||console.error("Error Compiling Fragment Shader!\n",e.getShaderInfoLog(s),et(r)),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){const t=e.getProgramInfoLog(i);console.error("Error in program linking:",t)}return this.uniformSetters=function(t,e){let r=0;function n(e,n){const i=t.getUniformLocation(e,n.name),s=n.size>1&&"[0]"===n.name.substr(-3),a=n.type,o=x[a];if(!o)throw"unknown type: 0x"+a.toString(16);if(null==i)return;let u;if(function(t){return null===t.Type}(o)){const e=r;r+=n.size,u=s?o.arraySetter(t,a,e,i,n.size):o.setter(t,a,e,i)}else u=o.arraySetter&&s?o.arraySetter(t,i):o.setter(t,i);return{setter:u,location:i}}const i={},s=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let r=0;r<s;++r){const s=t.getActiveUniform(e,r);if(!s)continue;let a=s.name;if("[0]"===a.substr(-3)&&(a=a.substr(0,a.length-3)),e){const t=n(e,s);t&&(i[a]=t)}}return i}(e,i),this.attributeSetters=function(t,e){const r={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let i=0;i<n;i++){const n=t.getActiveAttrib(e,i);if(!n)break;const s=t.getAttribLocation(e,n.name),a=X[n.type],o=a.setter(t,s,a);r[n.name]={setter:o,location:s}}return r}(e,i),this.fragSource=r,this.vertSource=n,this}}destroy(){this.gl.deleteProgram(this.program),this.gl.deleteShader(this.frag),this.gl.deleteShader(this.vert)}}function et(t){return t.trim().split("\n").map((t,e)=>e+1+": "+t).join("\n")}let rt=1;class nt{constructor(t="Sketch"+rt++){this.id=t}update(t){return t.drawSettings&&(this.drawSettings=t.drawSettings),t.form&&(this.form=t.form),t.shade&&(this.shade=t.shade),t.uniforms&&(this.uniforms=t.uniforms),this}destroy(){this.form&&this.form.destroy(),this.shade&&this.shade.destroy()}}class it{constructor(t){this.gl=t,this.targets=[{id:"MainTarget_1"},{id:"MainTarget_2"}],this.resize({forceUpdateTargets:!0,keepCurrentSize:!(!t.canvas.width||!t.canvas.height)}),this.renderQuad=this.createForm().update(A.renderQuad),this.result=this.createFlatSketch()}resize({multiplier:t=1,forceUpdateTargets:e=!1,keepCurrentSize:r=!1}={}){const n=this.gl.canvas;return(r||m(n,t)||e)&&this.targets.forEach(t=>{t.width===n.width&&t.height===n.height||(t.width=n.width,t.height=n.height,t.textureConfig={count:1,type:this.gl.UNSIGNED_BYTE},Y(this.gl,t,_))}),this}destroy(){this.result.destroy();for(const t of this.targets)k(this.gl,t)}updateDrawSettings(t){return H(this.gl,Object.assign({},h(this.gl),t)),this}createForm(t){return new $(this.gl,t)}createShade(t){return new tt(this.gl,t)}createSketch(t){return new nt(t)}createFlatSketch(t){const e=this.createSketch(t);return e.update({form:this.renderQuad,shade:this.createShade(e.id+"_defaultShade").update(d.basicEffect)})}createStaticLayer(t){return new Q(this.gl,t)}createDrawingLayer(t){return new J(this.gl,t)}createEffectLayer(t){const e=this.createDrawingLayer(t);return e.update({sketches:[this.createFlatSketch(e.id+"_effectSketch")]})}draw(t,e){return st(this.gl,t,null,e),this}compose(...t){return function(t,e,r,n){const i=e.length-1;for(let s=0;s<e.length;s++){const a=e[s];if(Array.isArray(a.uniforms)){const e=i+a.uniforms.length-1;a.looping=!1;for(let i=0;i<a.uniforms.length;i++){0;const o=s+i===e;ut(t,a,r,a.uniforms[i],n,o)}}else{const e=s===i;ut(t,a,r,a.uniforms,n,e)}}}(this.gl,t,this.targets,this.result),this}}function st(t,e,r,n){const{shade:i,form:s,drawSettings:a,uniforms:o}=e;if(!i||!s)throw Error("cannot draw, shader or geometry are not set");if(t.useProgram(i.program),function(t,e){for(const r in e.attribs){const n=t.attributeSetters[r];n&&n.setter(e.attribs[r])}}(i,s),n&&ot(i,n,r),a&&H(t,a),Array.isArray(o))for(const n of o)at(t,e,r,n);else at(t,e,r,o);a&&W(t,a)}function at(t,e,r,n){n&&ot(e.shade,n,r),e.form.elements&&null!=e.form.elements.glType?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.form.elements.buffer),t.drawElements(e.form.drawType,e.form.itemCount,e.form.elements.glType,0)):t.drawArrays(e.form.drawType,0,e.form.itemCount)}function ot(t,e,r){for(const n in e){const i=t.uniformSetters[n];if(i){let t=e[n];"function"==typeof t&&(t=t()),null===t||"string"==typeof t?i.setter(r):i.setter(t)}}}function ut(t,e,r,n,i,s){const a=r[0],o=r[1];if(s)t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight);else if(e.targets){const r=e.targets.length-1;0,t.bindFramebuffer(t.FRAMEBUFFER,e.targets[r].frameBuffer),t.viewport(0,0,e.targets[r].width,e.targets[r].height)}else t.bindFramebuffer(t.FRAMEBUFFER,o.frameBuffer),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight);if(e.data.drawSettings&&H(t,e.data.drawSettings),e.sketches)for(const r of e.sketches)st(t,r,e.looping&&e.texture()||a.textures[0],n);else st(t,i,null,{source:e.texture()});if(e.data.drawSettings&&W(t,e.data.drawSettings),!s)if(e.targets){if(2===e.targets.length){const t=e.targets[0];e.targets[0]=e.targets[1],e.targets[1]=t,e.looping=!0}}else r[0]=o,r[1]=a}it.debug=!1,r.d(e,"utils",function(){return ft}),r.d(e,"lib",function(){return lt}),r.d(e,"constants",function(){return ct}),r.d(e,"Painter",function(){return it});const ft={geometry:{plane:a},stackgl:o,context:s},lt=i,ct=n}])});