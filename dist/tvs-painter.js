!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.tvsPainter=e():t.tvsPainter=e()}(self,(()=>(()=>{"use strict";var t={d:(e,r)=>{for(var i in r)t.o(r,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:r[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Painter:()=>at,constants:()=>Tt,lib:()=>Et,utils:()=>ht});var r={};t.r(r),t.d(r,{GEOMETRY_PROP_NORMAL:()=>u,GEOMETRY_PROP_POSITION:()=>f,GEOMETRY_PROP_UV:()=>_,GL_TYPE:()=>h,TEXTURE_FORMAT:()=>E,TEXTURE_FORMAT_DEFAULTS:()=>R,TEXTURE_FORMAT_INTERNAL:()=>T,UNIFORM_SOURCE_TEXTURE:()=>o,VARYING_UV_COORDS:()=>l});var i={};t.r(i),t.d(i,{defaultForms:()=>A,defaultShaders:()=>m,defaultTextureSettings:()=>c,getDefaultLayerSettings:()=>d});var s={};t.r(s),t.d(s,{makeClear:()=>S,resizeCanvas:()=>g,setBlendFunc:()=>F});var n={};t.r(n),t.d(n,{plane:()=>y});var a={};t.r(a),t.d(a,{STACK_GL_GEOMETRY_PROP_ELEMENTS:()=>B,STACK_GL_GEOMETRY_PROP_NORMAL:()=>N,STACK_GL_GEOMETRY_PROP_POSITION:()=>p,STACK_GL_GEOMETRY_PROP_UV:()=>U,convertStackGLGeometry:()=>I});const f="position",u="normal",_="uv",o="source",l="coords",h={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FLOAT_MAT2X3:35685,FLOAT_MAT2X4:35686,FLOAT_MAT3X2:35687,FLOAT_MAT3X4:35688,FLOAT_MAT4X2:35689,FLOAT_MAT4X3:35690,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,TEXTURE_2D:3553,TEXTURE_CUBE_MAP:34067,TEXTURE_3D:32879,TEXTURE_2D_ARRAY:35866,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,HALF_FLOAT:5131,UNSIGNED_INT_2_10_10_10_REV:33640,UNSIGNED_INT_10F_11F_11F_REV:35899,UNSIGNED_INT_5_9_9_9_REV:35902,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,UNSIGNED_INT_24_8:34042},E={RED:6403,RG:33319,RGB:6407,RGBA:6408,RED_INTEGER:36244,RG_INTEGER:33320,RGB_INTEGER:36248,RGBA_INTEGER:36249,DEPTH_COMPONENT:6402},T={R8:33321,RG8:33323,RGB8:32849,RGBA8:32856,R16F:33325,RG16F:33327,RGB16F:34843,RGBA16F:34842,R32F:33326,RG32F:33328,RGB32F:34837,RGBA32F:34836,R8I:33329,RG8I:33335,RGB8I:36239,RGBA8I:36238,R8UI:33330,RG8UI:33336,RGB8UI:36221,RGBA8UI:36220,R16I:33331,RG16I:33337,RGB16I:36233,RGBA16I:36232,R16UI:33332,RG16UI:33338,RGB16UI:36215,RGBA16UI:36214,R32I:33333,RG32I:33339,RGB32I:36227,RGBA32I:36226,R32UI:33334,RG32UI:33340,RGB32UI:36209,RGBA32UI:36208,RGB10_A2:32857,RGB10_A2UI:36975,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,DEPTH_COMPONENT16:33189,DEPTH_COMPONENT24:33190,DEPTH_COMPONENT32F:36012},R={[h.UNSIGNED_BYTE]:{[E.RED]:T.R8,[E.RG]:T.RG8,[E.RGB]:T.RGB8,[E.RGBA]:T.RGBA8},[h.UNSIGNED_SHORT]:{[E.DEPTH_COMPONENT]:T.DEPTH_COMPONENT16,[E.RED]:T.R16UI,[E.RG]:T.RG16UI,[E.RGB]:T.RGB16UI,[E.RGBA]:T.RGBA16UI},[h.UNSIGNED_INT]:{[E.DEPTH_COMPONENT]:T.DEPTH_COMPONENT24,[E.RED]:T.R32UI,[E.RG]:T.RG32UI,[E.RGB]:T.RGB32UI,[E.RGBA]:T.RGBA32UI},[h.FLOAT]:{[E.RED]:T.R16F,[E.RG]:T.RG16F,[E.RGB]:T.RGB16F,[E.RGBA]:T.RGBA16F,[E.DEPTH_COMPONENT]:T.DEPTH_COMPONENT32F},COMPRESSED_TYPES:{}},c={wrap:"CLAMP_TO_EDGE",minFilter:"LINEAR",magFilter:"NEAREST"};function d(t){return{clearColor:[0,0,0,1],blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA]}}const A={renderQuad:{attribs:{[f]:{buffer:new Float32Array([-1,1,-1,-1,1,1,1,-1]),storeType:"STATIC"},[_]:{buffer:new Float32Array([0,1,0,0,1,1,1,0]),storeType:"STATIC"}},drawType:"TRIANGLE_STRIP",itemCount:4}},m={basicEffect:{vert:`\nattribute vec2 ${f};\nattribute vec2 ${_};\nvarying vec2 ${l};\nvoid main() {\n\t${l} = ${_};\n\tgl_Position = vec4(${f}, 0.0, 1.0);\n}`,frag:`precision mediump float;\nuniform sampler2D ${o};\nvarying vec2 ${l};\nvoid main() {\n\tgl_FragColor = texture2D(${o}, ${l});\n}`}};function S(t,...e){return e.reduce(((e,r)=>e|t[r.toUpperCase()+"_BUFFER_BIT"]),0)}function F(t,e){t.blendFunc.apply(t,e.map((e=>t[e.toUpperCase()])))}function g(t,e=1){let r=t.width,i=t.height;if("clientWidth"in t){const s=t.getBoundingClientRect();r=s.width*e|0,i=s.height*e|0}return(t.width!==r||t.height!==i)&&(t.width=r,t.height=i,!0)}function y(t,e,r,i){const s=t/2,n=e/2,a=r||1,f=i||1,u=a+1,_=f+1,o=t/a,l=e/f,h=new Float32Array(u*_*3),E=new Float32Array(u*_*3),T=new Float32Array(u*_*2);let R,c,d=0,A=0;for(R=0;R<_;R++){const t=R*l-n;for(c=0;c<u;c++){const e=c*o-s;h[d]=e,h[d+1]=-t,E[d+2]=1,T[A]=c/a,T[A+1]=1-R/f,d+=3,A+=2}}d=0;const m=new(h.length/3>65535?Uint32Array:Uint16Array)(a*f*6);for(R=0;R<f;R++)for(c=0;c<a;c++){const t=c+u*R,e=c+u*(R+1),r=c+1+u*(R+1),i=c+1+u*R;m[d]=t,m[d+1]=e,m[d+2]=i,m[d+3]=e,m[d+4]=r,m[d+5]=i,d+=6}return{attribs:{position:{buffer:h},normal:{buffer:E},uv:{buffer:T}},elements:{buffer:m},drawType:"TRIANGLES",itemCount:m.length}}function b(t,e=[]){for(const r of t){const t=e.length;for(let i=0;i<r.length;i++)e[i+t]=r[i]}return e}const p="positions",N="normals",U="uvs",B="cells";function I(t){const e={drawType:"TRIANGLES",attribs:{},itemCount:0};for(const r in t){const i=t[r];if(r===B){const t=new(i.length>65535?Uint32Array:Uint16Array)(b(i));Object.assign(e,{elements:{buffer:t},itemCount:t.length})}else r===p?e.attribs[f]={buffer:new Float32Array(b(i))}:r===N?e.attribs[u]={buffer:new Float32Array(b(i))}:r===U?e.attribs[_]={buffer:new Float32Array(b(i))}:e.attribs[r]={buffer:new Float32Array(b(i))}}return e}function O(t){return x[t].bindPoint}function L(t,e){return r=>{t.uniform1i(e,r)}}function D(t,e){return r=>{t.uniform1iv(e,r)}}function M(t,e){return r=>{t.uniform2iv(e,r)}}function P(t,e){return r=>{t.uniform3iv(e,r)}}function G(t,e){return r=>{t.uniform4iv(e,r)}}function w(t,e,r,i){const s=O(e);return e=>{t.uniform1i(i,r),t.activeTexture(t.TEXTURE0+r),t.bindTexture(s,e._texture)}}function C(t,e,r,i,s){const n=O(e),a=new Int32Array(s);for(let t=0;t<s;++t)a[t]=r+t;return e=>{t.uniform1iv(i,a);for(const r in e)t.activeTexture(t.TEXTURE0+a[r]),t.bindTexture(n,e[r]._texture)}}const x={[h.FLOAT]:{Type:Float32Array,size:4,setter:function(t,e){return r=>{t.uniform1f(e,r)}},arraySetter:function(t,e){return r=>{t.uniform1fv(e,r)}}},[h.FLOAT_VEC2]:{Type:Float32Array,size:8,setter:function(t,e){return r=>{t.uniform2fv(e,r)}}},[h.FLOAT_VEC3]:{Type:Float32Array,size:12,setter:function(t,e){return r=>{t.uniform3fv(e,r)}}},[h.FLOAT_VEC4]:{Type:Float32Array,size:16,setter:function(t,e){return r=>{t.uniform4fv(e,r)}}},[h.INT]:{Type:Int32Array,size:4,setter:L,arraySetter:D},[h.INT_VEC2]:{Type:Int32Array,size:8,setter:M},[h.INT_VEC3]:{Type:Int32Array,size:12,setter:P},[h.INT_VEC4]:{Type:Int32Array,size:16,setter:G},[h.UNSIGNED_INT]:{Type:Uint32Array,size:4,setter:function(t,e){return r=>{t.uniform1ui(e,r)}},arraySetter:function(t,e){return r=>{t.uniform1uiv(e,r)}}},[h.UNSIGNED_INT_VEC2]:{Type:Uint32Array,size:8,setter:function(t,e){return r=>{t.uniform2uiv(e,r)}}},[h.UNSIGNED_INT_VEC3]:{Type:Uint32Array,size:12,setter:function(t,e){return r=>{t.uniform3uiv(e,r)}}},[h.UNSIGNED_INT_VEC4]:{Type:Uint32Array,size:16,setter:function(t,e){return r=>{t.uniform4uiv(e,r)}}},[h.BOOL]:{Type:Uint32Array,size:4,setter:L,arraySetter:D},[h.BOOL_VEC2]:{Type:Uint32Array,size:8,setter:M},[h.BOOL_VEC3]:{Type:Uint32Array,size:12,setter:P},[h.BOOL_VEC4]:{Type:Uint32Array,size:16,setter:G},[h.FLOAT_MAT2]:{Type:Float32Array,size:16,setter:function(t,e){return r=>{t.uniformMatrix2fv(e,!1,r)}}},[h.FLOAT_MAT3]:{Type:Float32Array,size:36,setter:function(t,e){return r=>{t.uniformMatrix3fv(e,!1,r)}}},[h.FLOAT_MAT4]:{Type:Float32Array,size:64,setter:function(t,e){return r=>{t.uniformMatrix4fv(e,!1,r)}}},[h.FLOAT_MAT2X3]:{Type:Float32Array,size:24,setter:function(t,e){return r=>{t.uniformMatrix2x3fv(e,!1,r)}}},[h.FLOAT_MAT2X4]:{Type:Float32Array,size:32,setter:function(t,e){return r=>{t.uniformMatrix2x4fv(e,!1,r)}}},[h.FLOAT_MAT3X2]:{Type:Float32Array,size:24,setter:function(t,e){return r=>{t.uniformMatrix3x2fv(e,!1,r)}}},[h.FLOAT_MAT3X4]:{Type:Float32Array,size:48,setter:function(t,e){return r=>{t.uniformMatrix3x4fv(e,!1,r)}}},[h.FLOAT_MAT4X2]:{Type:Float32Array,size:32,setter:function(t,e){return r=>{t.uniformMatrix4x2fv(e,!1,r)}}},[h.FLOAT_MAT4X3]:{Type:Float32Array,size:48,setter:function(t,e){return r=>{t.uniformMatrix4x3fv(e,!1,r)}}},[h.SAMPLER_2D]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D},[h.SAMPLER_CUBE]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_CUBE_MAP},[h.SAMPLER_3D]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_3D},[h.SAMPLER_2D_SHADOW]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D},[h.SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D_ARRAY},[h.SAMPLER_2D_ARRAY_SHADOW]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D_ARRAY},[h.SAMPLER_CUBE_SHADOW]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_CUBE_MAP},[h.INT_SAMPLER_2D]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D},[h.INT_SAMPLER_3D]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_3D},[h.INT_SAMPLER_CUBE]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_CUBE_MAP},[h.INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D_ARRAY},[h.UNSIGNED_INT_SAMPLER_2D]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D},[h.UNSIGNED_INT_SAMPLER_3D]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_3D},[h.UNSIGNED_INT_SAMPLER_CUBE]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_CUBE_MAP},[h.UNSIGNED_INT_SAMPLER_2D_ARRAY]:{Type:null,size:0,setter:w,arraySetter:C,bindPoint:h.TEXTURE_2D_ARRAY}};function v(t,e,r){return i=>{t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribPointer(e,r.itemSize,h.FLOAT,!1,0,0),t.enableVertexAttribArray(e)}}function z(t,e,r){return i=>{t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribIPointer(e,r.itemSize,h.INT,0,0),t.enableVertexAttribArray(e)}}function X(t,e,r){const i=r.size,s=r.count;return r=>{t.bindBuffer(t.ARRAY_BUFFER,r);const n=i,a=n/s,f=x[h.FLOAT].size*n,u=f/s;for(let r=0;r<s;++r)t.vertexAttribPointer(e+r,a,h.FLOAT,!1,f,u*r),t.enableVertexAttribArray(e+r)}}const V={[h.FLOAT]:{size:4,setter:v,itemSize:1},[h.FLOAT_VEC2]:{size:8,setter:v,itemSize:2},[h.FLOAT_VEC3]:{size:12,setter:v,itemSize:3},[h.FLOAT_VEC4]:{size:16,setter:v,itemSize:4},[h.INT]:{size:4,setter:z,itemSize:1},[h.INT_VEC2]:{size:8,setter:z,itemSize:2},[h.INT_VEC3]:{size:12,setter:z,itemSize:3},[h.INT_VEC4]:{size:16,setter:z,itemSize:4},[h.UNSIGNED_INT]:{size:4,setter:z,itemSize:1},[h.UNSIGNED_INT_VEC2]:{size:8,setter:z,itemSize:2},[h.UNSIGNED_INT_VEC3]:{size:12,setter:z,itemSize:3},[h.UNSIGNED_INT_VEC4]:{size:16,setter:z,itemSize:4},[h.BOOL]:{size:4,setter:z,itemSize:1},[h.BOOL_VEC2]:{size:8,setter:z,itemSize:2},[h.BOOL_VEC3]:{size:12,setter:z,itemSize:3},[h.BOOL_VEC4]:{size:16,setter:z,itemSize:4},[h.FLOAT_MAT2]:{size:4,setter:X,count:2},[h.FLOAT_MAT3]:{size:9,setter:X,count:3},[h.FLOAT_MAT4]:{size:16,setter:X,count:4}};function Y(t,e){if(e.enable)for(const r of e.enable)t.enable(r);if(e.disable)for(const r of e.disable)t.disable(r);e.blendFunc&&t.blendFunc.apply(t,e.blendFunc),e.blendFuncSeparate&&t.blendFuncSeparate.apply(t,e.blendFuncSeparate),null!=e.depthFunc&&t.depthFunc(e.depthFunc),null!=e.cullFace&&t.cullFace(e.cullFace),null!=e.frontFace&&t.frontFace(e.frontFace),null!=e.lineWidth&&t.lineWidth(e.lineWidth),e.colorMask&&t.colorMask.apply(t,e.colorMask),null!=e.depthMask&&t.depthMask(e.depthMask),e.clearColor&&t.clearColor.apply(t,e.clearColor),null!=e.clearDepth&&t.clearDepth(e.clearDepth),null!=e.clearBits&&t.clear(e.clearBits)}function H(t,e){if(e.enable)for(const r of e.enable)t.disable(r);if(e.disable)for(const r of e.disable)t.enable(r)}h.BYTE,Int8Array,h.UNSIGNED_BYTE,Uint8Array,h.SHORT,Int16Array,h.UNSIGNED_SHORT,Uint16Array,h.INT,Int32Array,h.UNSIGNED_INT,Uint32Array,h.FLOAT,Float32Array,h.UNSIGNED_SHORT_4_4_4_4,Uint16Array,h.UNSIGNED_SHORT_5_5_5_1,Uint16Array,h.UNSIGNED_SHORT_5_6_5,Uint16Array,h.HALF_FLOAT,Uint16Array,h.UNSIGNED_INT_2_10_10_10_REV,Uint32Array,h.UNSIGNED_INT_10F_11F_11F_REV,Uint32Array,h.UNSIGNED_INT_5_9_9_9_REV,Uint32Array,h.FLOAT_32_UNSIGNED_INT_24_8_REV,Uint32Array,h.UNSIGNED_INT_24_8,Uint32Array;let k=1;class W{constructor(t,e="Form"+k++){this._painter=t,this.id=e,this._attribBuffers=null,this._customLayout=null}update(t){const e=this._painter.gl;if(t.drawType&&(this._drawType=e[t.drawType]),t.itemCount&&(this._itemCount=t.itemCount),t.customLayout){this._customLayout=this._customLayout||{attribs:{}};const r=t.customLayout.data;r&&(null==this._customLayout.buffer&&(this._customLayout.buffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this._customLayout.buffer),e.bufferData(e.ARRAY_BUFFER,r.buffer,e[(r.storeType||"STATIC")+"_DRAW"]));let i=this._customLayout.attribs;for(let s in t.customLayout.layout){let n=t.customLayout.layout[s];if(i[s]?Object.assign(i[s],n):i[s]=Object.assign({},n),!r&&n.data){let t=i[s];null==t.buffer&&(t.buffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,t.buffer),e.bufferData(e.ARRAY_BUFFER,n.data.buffer,e[(n.data.storeType||"STATIC")+"_DRAW"])}}}if(t.attribs){this._attribBuffers=this._attribBuffers||{};for(const r in t.attribs){const i=t.attribs[r];null==this._attribBuffers[r]&&(this._attribBuffers[r]=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this._attribBuffers[r]),e.bufferData(e.ARRAY_BUFFER,i.buffer,e[(i.storeType||"STATIC")+"_DRAW"])}}if(t.elements){const r=t.elements.buffer;null==this._elements&&(this._elements={buffer:e.createBuffer(),glType:null}),this._elements.glType=function(t){if(t instanceof Int8Array)return h.BYTE;if(t instanceof Uint8Array)return h.UNSIGNED_BYTE;if(t instanceof Uint8ClampedArray)return h.UNSIGNED_BYTE;if(t instanceof Int16Array)return h.SHORT;if(t instanceof Uint16Array)return h.UNSIGNED_SHORT;if(t instanceof Int32Array)return h.INT;if(t instanceof Uint32Array)return h.UNSIGNED_INT;if(t instanceof Float32Array)return h.FLOAT;throw new Error("unsupported typed array type")}(r),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._elements.buffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,r,e[(t.elements.storeType||"STATIC")+"_DRAW"])}else null===t.elements&&this._elements&&(e.deleteBuffer(this._elements.buffer),this._elements=void 0);return this}destroy(){const t=this._painter.gl;if(this._attribBuffers)for(const e in this._attribBuffers)t.deleteBuffer(this._attribBuffers[e]);if(this._customLayout){null!=this._customLayout.buffer&&t.deleteBuffer(this._customLayout.buffer);for(const e in this._customLayout.attribs)null!=this._customLayout.attribs[e].buffer&&t.deleteBuffer(this._customLayout.attribs[e].buffer)}this._attribBuffers=null,this._customLayout=null,this._elements&&(t.deleteBuffer(this._elements.buffer),this._elements=void 0)}}let j=1;class ${constructor(t,e="Texture"+j++){this._painter=t,this.id=e,this._texture=null,this._data={}}update(t){const e=this._painter.gl;if(null==this._texture&&(this._texture=e.createTexture()),e.bindTexture(e.TEXTURE_2D,this._texture),t.wrap&&t.wrap!==this._data.wrap||t.wrapS&&t.wrapS!==this._data.wrapS||t.wrapT&&t.wrapT!==this._data.wrapT){let r,i;t.wrap?r=i=t.wrap:(i=t.wrapT||c.wrap,r=t.wrapS||c.wrap),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[r]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[i])}else this._data.wrap||this._data.wrapS||this._data.wrapT||(this._data.wrap=this._data.wrapT=this._data.wrapS=c.wrap,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[this._data.wrap]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[this._data.wrap]));return t.magFilter&&t.magFilter!==this._data.magFilter?e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[t.magFilter]):this._data.magFilter||(this._data.magFilter=c.magFilter,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[this._data.magFilter])),t.minFilter&&t.minFilter!==this._data.minFilter?e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[t.minFilter]):this._data.minFilter||(this._data.minFilter=c.minFilter,e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[this._data.minFilter])),t.asset&&e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.asset),void 0!==t.data&&e.texImage2D(e.TEXTURE_2D,0,"FLOAT"===t.type?e.RGBA32F:e.RGBA,t.width,t.height,0,e.RGBA,e[t.type||"UNSIGNED_BYTE"],t.data),null!=t.flipY&&t.flipY!==this._data.flipY&&e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY),t.minFilter&&t.minFilter.indexOf("MIPMAP")>0&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),Object.assign(this._data,t),this}destroy(){this._painter.gl.deleteTexture(this._texture),this._data={},this._texture=null}}let K=1;class Q{constructor(t,e="Form"+K++){this._painter=t,this.id=e,this.width=0,this.height=0,this.antialias=!1,this.frameBuffer=null,this.antiAliasFrameBuffer=null,this.antiAliasRenderBuffer=null,this.textures=[],this.depthBuffer=null,this.bufferStructure=[],this._data={}}update(t){var e;const r=this._painter.gl,i=t.width||this.width,s=t.height||this.height;if(!i||!s)return this;if(i===this.width&&s===this.height){if(!t.bufferStructure)return this;if(t.bufferStructure.length===this.bufferStructure.length&&this.bufferStructure.every(((e,r)=>function(t,e){if(t===e)return!0;if(!e)return!1;const r=Object.keys(t);if(!function(t,e){if(t===e)return!0;if(!e||!t)return!1;if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}(r,Object.keys(e)))return!1;for(const i of r)if(t[i]!==e[i])return!1;return!0}(e,t.bufferStructure[r]))))return this}null==this.frameBuffer&&(this.frameBuffer=r.createFramebuffer()),null==this.depthBuffer&&(this.depthBuffer=r.createRenderbuffer()),t.bufferStructure&&t.bufferStructure.length&&(this.bufferStructure=t.bufferStructure,this.bufferStructure.some((t=>"FLOAT"===t.type))&&r.getExtension("EXT_color_buffer_float"));const n=this.bufferStructure.length||1,a=[r.COLOR_ATTACHMENT0];if(r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer),n>1){const t=r.COLOR_ATTACHMENT0;for(let e=0;e<n;e++)a[e]=t+e;r.drawBuffers(a)}this.antialias=1===n&&(t.antialias||(null===(e=this._data)||void 0===e?void 0:e.antialias)),this.antialias?(null==this.antiAliasFrameBuffer&&(this.antiAliasFrameBuffer=r.createFramebuffer()),null==this.antiAliasRenderBuffer&&(this.antiAliasRenderBuffer=r.createRenderbuffer()),r.bindFramebuffer(r.FRAMEBUFFER,this.antiAliasFrameBuffer),r.bindRenderbuffer(r.RENDERBUFFER,this.antiAliasRenderBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(4,r.getParameter(r.MAX_SAMPLES)),r.RGBA8,i,s),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this.antiAliasRenderBuffer),r.bindRenderbuffer(r.RENDERBUFFER,this.depthBuffer),r.renderbufferStorageMultisample(r.RENDERBUFFER,Math.min(4,r.getParameter(r.MAX_SAMPLES)),r.DEPTH_COMPONENT16,i,s),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this.depthBuffer),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer)):(r.bindRenderbuffer(r.RENDERBUFFER,this.depthBuffer),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,i,s),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,this.depthBuffer));for(let t=0;t<n;t++){this.textures[t]||(this.textures[t]=new $(this._painter,this.id+"_Texture"+t));const e=this.textures[t];e.update(Object.assign(Object.assign({minFilter:"NEAREST",magFilter:"NEAREST"},this.bufferStructure[t]),{data:null,width:i,height:s})),r.framebufferTexture2D(r.FRAMEBUFFER,a[t],r.TEXTURE_2D,e._texture,0)}if(this.antialias){r.bindFramebuffer(r.FRAMEBUFFER,this.antiAliasFrameBuffer);const e=r.checkFramebufferStatus(r.FRAMEBUFFER);e!==r.FRAMEBUFFER_COMPLETE&&console.error("antialias framebuffer error",e,t),r.bindFramebuffer(r.FRAMEBUFFER,this.frameBuffer)}const f=r.checkFramebufferStatus(r.FRAMEBUFFER);return f!==r.FRAMEBUFFER_COMPLETE&&console.error("framebuffer error",f,t),r.bindFramebuffer(r.FRAMEBUFFER,null),r.bindTexture(r.TEXTURE_2D,null),r.bindRenderbuffer(r.RENDERBUFFER,null),Object.assign(this._data,t),this.width=i,this.height=s,this}destroy(){const t=this._painter.gl;t.deleteFramebuffer(this.frameBuffer),t.deleteRenderbuffer(this.depthBuffer);for(const e of this.textures)t.deleteTexture(e);this.antiAliasFrameBuffer&&t.deleteFramebuffer(this.antiAliasFrameBuffer),this.antiAliasRenderBuffer&&t.deleteRenderbuffer(this.antiAliasRenderBuffer),this.textures=[],this.frameBuffer=null,this.depthBuffer=null,this._data={},this.bufferStructure=[],this.width=0,this.height=0}}let q=1;class J{constructor(t,e="Layer"+q++){this._painter=t,this.id=e,this.sketches=[],this.effects=[],this.width=0,this.height=0,this._targets=[],this._textures=[],this._passCount=0,this._data={},this._uniforms=null}image(t=0){return this._targets.length&&this._targets[this._targets.length-1].textures[t]||this._textures[t]}update(t={}){var e,r,i,s;t.sketches&&(this.sketches=Array.isArray(t.sketches)?t.sketches:[t.sketches]),t.effects&&(this.effects=Array.isArray(t.effects)?t.effects:[t.effects]),t.uniforms&&(this._uniforms=t.uniforms);const n=t.selfReferencing||this._data.selfReferencing;let a=this.effects.reduce(((t,e)=>t+(e._uniforms.length||1)),this.sketches.length?1:0);const f=n||a>1?2:a;(t.directRender||this._data.directRender)&&(a-=1),this._passCount=a;const u=this._painter.gl,_=t.width||(null===(e=t.texture)||void 0===e?void 0:e.width)||this._data.width||(null===(r=this._data.texture)||void 0===r?void 0:r.width)||u.drawingBufferWidth,o=t.height||(null===(i=t.texture)||void 0===i?void 0:i.height)||this._data.height||(null===(s=this._data.texture)||void 0===s?void 0:s.height)||u.drawingBufferHeight,l=t.antialias||this._data.antialias||!0;f!==this._targets.length&&this._destroyTargets();const h=Object.assign(Object.assign({},t),{width:_,height:o,antialias:l});return!this._targets.length&&f>0?this._targets=function(t,e,r=[]){for(let i=0;i<e;i++)r[i]=t(i);return r}((t=>new Q(this._painter,this.id+"_target"+(t+1)).update(h)),f):this._targets.length&&this._targets.forEach((t=>{t.update(h)})),t.texture&&(this._textures[0]||(this._textures[0]=new $(this._painter,this.id+"_Texture0")),t.texture.width=_,t.texture.height=o,this._textures[0].update(t.texture)),Object.assign(this._data,t),this.width=_,this.height=o,this}destroy(){this._destroyTargets(),this.clear()}clear(){this.effects=[];for(const t of this._textures)t.destroy();this.effects=[],this.sketches=[],this.width=0,this.height=0,this._data={},this._textures=[],this._uniforms=null}_destroyTargets(){this._targets.forEach((t=>t.destroy())),this._targets=[]}_swapTargets(){if(this._targets.length>1){const t=this._targets[0];this._targets[0]=this._targets[1],this._targets[1]=t}}}let Z=1;class tt{constructor(t,e="Shade"+Z++){this._painter=t,this.id=e}update(t){const e=this._painter.gl,r=t.frag&&t.frag.trim()||this.fragSource,i=t.vert&&t.vert.trim()||this.vertSource;if(!r||!i||r===this.fragSource&&i===this.vertSource)return this;this.destroy(),r.indexOf("GL_EXT_draw_buffers")>=0&&e.getExtension("WEBGL_draw_buffers");const s=e.createProgram(),n=e.createShader(e.FRAGMENT_SHADER),a=e.createShader(e.VERTEX_SHADER);if(!(s&&a&&n))return this;if(this._program=s,this._frag=n,this._vert=a,e.attachShader(s,a),e.attachShader(s,n),e.shaderSource(a,i),e.shaderSource(n,r),e.compileShader(a),e.compileShader(n),e.getShaderParameter(a,e.COMPILE_STATUS)||console.error("Error Compiling Vertex Shader!\n",e.getShaderInfoLog(a),et(i)),e.getShaderParameter(n,e.COMPILE_STATUS)||console.error("Error Compiling Fragment Shader!\n",e.getShaderInfoLog(n),et(r)),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){const t=e.getProgramInfoLog(s);console.error("Error in program linking:",t)}return this._uniforms=function(t,e){let r=0;function i(e,i){const s=t.getUniformLocation(e,i.name),n=i.size>1&&"[0]"===i.name.substr(-3),a=i.type,f=x[a];if(!f)throw new Error("unknown type: 0x"+a.toString(16));if(null==s)return;let u;if(null===f.Type){const e=r;r+=i.size,u=n?f.arraySetter(t,a,e,s,i.size):f.setter(t,a,e,s)}else u=f.arraySetter&&n?f.arraySetter(t,s):f.setter(t,s);return{setter:u,location:s}}const s={},n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let r=0;r<n;++r){const n=t.getActiveUniform(e,r);if(!n)continue;let a=n.name;if("[0]"===a.substr(-3)&&(a=a.substr(0,a.length-3)),e){const t=i(e,n);t&&(s[a]=t)}}return s}(e,s),this._attributes=function(t,e){const r={},i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let s=0;s<i;s++){const i=t.getActiveAttrib(e,s);if(!i)break;const n=t.getAttribLocation(e,i.name),a=V[i.type],f=a.setter(t,n,a);r[i.name]={setter:f,location:n}}return r}(e,s),this.fragSource=r,this.vertSource=i,this}destroy(){const t=this._painter.gl;t.deleteProgram(this._program),t.deleteShader(this._frag),t.deleteShader(this._vert),this.vertSource=void 0,this.fragSource=void 0,this._attributes={},this._uniforms={}}}function et(t){return t.trim().split("\n").map(((t,e)=>e+1+": "+t)).join("\n")}let rt=1;class it{constructor(t="Sketch"+rt++){this.id=t,this._uniforms=[]}update(t){return t.drawSettings&&(this._drawSettings=t.drawSettings),t.form&&(this.form=t.form),t.shade&&(this.shade=t.shade),t.uniforms&&(this._uniforms=Array.isArray(t.uniforms)?t.uniforms:[t.uniforms]),this}destroy(){this.form=null,this.shade=null,this._drawSettings=void 0,this._uniforms=[]}}let st=1;class nt extends it{constructor(t,e,r="Effect"+st++){super(r),this.id=r,this.form=t,this.shade=e}update(t){var e;return t.frag&&(null===(e=this.shade)||void 0===e||e.update({frag:t.frag})),t.drawSettings&&(this._drawSettings=t.drawSettings),t.uniforms&&(this._uniforms=Array.isArray(t.uniforms)?t.uniforms:[t.uniforms]),this}}class at{constructor(t,e={}){this.canvas=t,this.maxBufferSamples=0;let r=null;if(r=t.getContext("webgl2",e)||t.getContext("experimental-webgl2",e),null==r)throw Error("Cannot initialize WebGL2.");this.gl=r,this.sizeMultiplier=e.sizeMultiplier||1,this.maxBufferSamples=r.getParameter(r.MAX_SAMPLES),this.resize(),Y(r,d(r)),this._renderQuad=this.createForm().update(A.renderQuad),this._staticEffect=this.createEffect(),this._defaultLayer=this.createLayer()}resize(){return g(this.gl.canvas,this.sizeMultiplier),this}destroy(){this._defaultLayer.destroy(),this._staticEffect.destroy(),this._renderQuad.destroy()}updateDrawSettings(t){return Y(this.gl,Object.assign({},t)),this}createForm(t){return new W(this,t)}createShade(t){return new tt(this,t)}createSketch(t){return new it(t)}createEffect(t){return new nt(this._renderQuad,this.createShade(t&&t+"_effectShade").update(m.basicEffect),t)}createLayer(t){return new J(this,t)}draw(t){return this._defaultLayer.update(Object.assign(Object.assign({},t),{directRender:!0})),this.compose(this._defaultLayer),this._defaultLayer.clear(),this}compose(...t){for(const e of t)lt(this.gl,e);return this}show(t,e){return this.draw({effects:this._staticEffect,uniforms:{source:t.image(e)}})}}function ft(t,e,r,i,s){if(t.useProgram(e._program),function(t,e,r){if(r._customLayout){const i=r._customLayout.buffer;null!=i&&t.bindBuffer(t.ARRAY_BUFFER,i);for(const i in r._customLayout.attribs){const s=e._attributes[i],n=r._customLayout.attribs[i];s&&(null!=n.buffer&&t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.vertexAttribPointer(s.location,n.size,n.type,n.normalize,n.stride,n.offset),t.enableVertexAttribArray(s.location))}}else for(const t in r._attribBuffers){const i=e._attributes[t];i&&i.setter(r._attribBuffers[t])}}(t,e,r),Array.isArray(i))for(const t of i)ut(e,t,s);else i&&ut(e,i,s);r._elements&&null!=r._elements.glType?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r._elements.buffer),t.drawElements(r._drawType,r._itemCount,r._elements.glType,0)):t.drawArrays(r._drawType,0,r._itemCount)}function ut(t,e,r){for(const i in e){const s=t._uniforms[i];if(s){let t=e[i];"function"==typeof t&&(t=t()),"string"==typeof t&&r?s.setter(r[t]):s.setter(t)}}}const _t=[];function ot(t,e,r){e?(t.bindFramebuffer(t.FRAMEBUFFER,e.antialias&&r?e.antiAliasFrameBuffer:e.frameBuffer),t.viewport(0,0,e.width,e.height)):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight))}function lt(t,e){let r=e._passCount;if(e.sketches.length){const i=r>0?e._targets[0]:void 0,s=e._textures.length?e._textures:e._targets[1]&&e._targets[1].textures;ot(t,i,!0),e._data.drawSettings&&Y(t,e._data.drawSettings),function(t,e,r,i){for(const s of e){if(!s.form||!s.shade)throw Error("cannot render incomplete sketch");if(s._drawSettings&&Y(t,s._drawSettings),Array.isArray(s._uniforms)&&s._uniforms.length)for(const e of s._uniforms)_t.length=0,r&&_t.push(r),_t.push(e),ft(t,s.shade,s.form,_t,i);else _t.length=0,r&&_t.push(r),s._uniforms&&_t.push(s._uniforms),ft(t,s.shade,s.form,_t,i);s._drawSettings&&H(t,s._drawSettings)}}(t,e.sketches,e._uniforms,s),function(t,e){e&&e.antialias&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,e.antiAliasFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e.frameBuffer),t.clearBufferfv(t.COLOR,0,[1,1,1,1]),t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,t.COLOR_BUFFER_BIT,t.LINEAR))}(t,i),e._swapTargets(),r--}if(e.effects.length)for(let i=0;i<e.effects.length;i++){const s=e.effects[i];if(!s.form||!s.shade)throw Error("cannot render incomplete effect");if(s._uniforms.length)for(let n=0;n<s._uniforms.length;n++){const a=r>0?e._targets[0]:void 0,f=n+i===0&&e._textures.length&&!e.sketches.length?e._textures:e._targets[1]&&e._targets[1].textures;ot(t,a,!1),e._data.drawSettings&&Y(t,e._data.drawSettings),s._drawSettings&&Y(t,s._drawSettings),_t.length=0,e._uniforms&&_t.push(e._uniforms),_t.push(s._uniforms[n]),ft(t,s.shade,s.form,_t,f),e._swapTargets(),r--}else{const n=r>0?e._targets[0]:void 0,a=0===i&&e._textures.length&&!e.sketches.length?e._textures:e._targets[1]&&e._targets[1].textures;ot(t,n,!1),e._data.drawSettings&&Y(t,e._data.drawSettings),s._drawSettings&&Y(t,s._drawSettings),_t.length=0,e._uniforms&&_t.push(e._uniforms),ft(t,s.shade,s.form,_t,a),e._swapTargets(),r--}s._drawSettings&&H(t,s._drawSettings)}e._data.drawSettings&&H(t,e._data.drawSettings)}const ht={geometry:{plane:n},stackgl:a,context:s},Et=i,Tt=r;return e})()));